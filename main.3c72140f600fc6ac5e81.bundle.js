(()=>{"use strict";var e,t,s,i={866:(e,t,s)=>{s.d(t,{fl:()=>K,T5:()=>V,k_:()=>U,eM:()=>Z,R$:()=>H,$7:()=>q,m6:()=>z,qs:()=>Y,gC:()=>F,Zu:()=>N,$K:()=>T,uF:()=>R,zq:()=>O,rb:()=>J,O2:()=>G,mO:()=>j,nI:()=>$,XG:()=>M,N8:()=>k,c6:()=>I,d5:()=>W,b2:()=>Q,Fl:()=>B});var i=s(557),o=s(168),r=s(534),a=s(334);class n extends Phaser.Scene{constructor(){super({key:"PreloadScene"})}preload(){this.loadAudio(),this.loadImg(),this.loadLevels(),this.load.html("dom_game_ui","assets/html/game_ui.html")}create(){this.scene.start("GameScene")}loadAudio(){Object.values(V).forEach((e=>this.load.audio(e,`assets/audio/music/${e}.mp3`))),this.load.audio("boink","assets/audio/sfx/jump/boink.mp3"),this.load.audio("pickup_present","assets/audio/sfx/pickup/pickup_coins.wav"),this.load.audio("death","assets/audio/sfx/crash/death.mp3"),this.load.audio("grunt","assets/audio/sfx/crash_grunt/grunt.mp3"),this.load.audio("applause","assets/audio/sfx/applause/applause.mp3"),this.load.audio("game_over_demon","assets/audio/sfx/game_over_demon/game_over_demon.mp3"),this.load.audio("snowboard_slide_04","assets/audio/sfx/nox_sound/snowboard_slide_loop_04.mp3"),this.load.audio("wind","assets/audio/sfx/wind/wind-seamless-02.mp3")}loadImg(){const e=H*$,t={360:"640x360",540:"960x540",720:"1280x720"}[[360,540,720].reduce(((t,s)=>Math.abs(s-e)<Math.abs(t-e)?s:t))];this.load.atlas("bg_space_pack",`assets/img/packed/bg_space_${t}.png`,`assets/img/packed/bg_space_${t}.json`),this.load.atlas("atlas_santa",`assets/img/packed/character_santa_${t}.png`,`assets/img/packed/character_santa_${t}.json`),this.load.atlas("atlas_environment",`assets/img/packed/environment_${t}.png`,`assets/img/packed/environment_${t}.json`)}loadLevels(){this.load.json("character_santa_old","assets/levels/export/character_santa_old.json"),this.load.json("character_santa","assets/levels/export/character_santa.json"),this.load.json(G.level_001,`assets/levels/export/${G.level_001}.json`),this.load.json(G.level_002,`assets/levels/export/${G.level_002}.json`),this.load.json(G.level_003,`assets/levels/export/${G.level_003}.json`),this.load.json(G.level_004,`assets/levels/export/${G.level_004}.json`)}}class l{static Clone(e){return new Q.b2Vec2(e.x,e.y)}static Add(e,t){return e.x+=t.x,e.y+=t.y,e}static Rotate(e,t){const s=Math.cos(t),i=Math.sin(t),o=e.x;return e.x=s*o-i*e.y,e.y=i*o+s*e.y,e}static Scale(e,t,s){return e.x*=t,e.y*=s||t,e}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));return 0===t||e.Set(e.x/t,e.y/t),e}}class h{constructor(e,t){this.zoomModifier=1/z,this.layers=[{color:0,width:7*this.zoomModifier},{color:9546960,width:10*this.zoomModifier},{color:11783922,width:20*this.zoomModifier}],this.scene=e,this.b2Physics=t;const s=new Q.b2BodyDef;this.terrainBody=this.b2Physics.world.CreateBody(s);const i=this.terrainBody.GetPosition(),o=this.b2Physics.rubeLoader.getBodiesByCustomProperty("string","surfaceType","snow")[0];if(!o)return;const r=o.GetFixtureList(),a=Q.castObject(r.GetShape(),Q.b2ChainShape),n=[];for(let e=0;e<a.get_m_count()-1;e++){let t=new Q.b2EdgeShape;a.GetChildEdge(t,e),n.push(l.Clone(t.m_vertex1),l.Clone(t.m_vertex2)),Q.destroy(t)}let h=0;const c=50*this.b2Physics.worldScale,d=[];let u=[];for(const[e,t]of n.reverse().entries()){const s=new Q.b2Vec2((t.x-i.x)*this.b2Physics.worldScale,-(t.y+i.y)*this.b2Physics.worldScale);u.push(s),0===e?h=s.x:e===n.length-1&&u.length&&d.length&&s.x-u[0].x<c&&d[d.length-1].push(...u),s.x-h>=c&&(d.push(u),u=[s],h=s.x)}d.forEach(((e,t)=>this.drawTerrain(e,t)))}drawTerrain(e,t){const s=Math.min(...e.map((e=>e.x))),i=Math.min(...e.map((e=>e.y))),o=this.scene.add.graphics().setDepth(10);o.setPosition(s,i);const r=e.map((e=>new Q.b2Vec2(e.x-s,e.y-i)));let a=r[0].y;for(const{y:e}of r)e>a&&(a=e);r.push(new Q.b2Vec2(r[r.length-1].x,a+2*this.scene.cameras.main.height)),r.push(new Q.b2Vec2(r[0].x,a+2*this.scene.cameras.main.height));let n=0;for(const{color:e,width:t}of this.layers)o.translateCanvas(0,n),o.fillStyle(e,1),o.fillPoints(r,!0,!1),o.translateCanvas(0,-n),n+=t/2}downloadTerrainImage(e,t){const s=Math.min(...t.map((e=>e.x))),i=Math.max(...t.map((e=>e.x))),o=Math.min(...t.map((e=>e.y))),r=i-s,a=Math.max(...t.map((e=>e.y)))-o,n="terrainChunk";e.generateTexture(n,r,a);const l=this.scene.textures.get(n).getSourceImage().toDataURL(),h=document.createElement("a");h.href=l,h.download=`${n}.png`,h.click()}}class c{constructor(e){this.loadedBodies=[],this.loadedJoints=[],this.loadedImages=[],this.bodyUserDataMap=new Map,this.customPropertiesArrayMap=new Map,this.customPropertiesMapMap=new Map,this.world=e}loadScene(e){this.loadedBodies=e.body?e.body.map((e=>this.loadBody(e))):this.loadedBodies,this.loadedJoints=e.joint?e.joint.map((e=>this.loadJoint(e))):this.loadedJoints,this.loadedImages=e.image?e.image.map((e=>this.loadImage(e))):this.loadedImages;const t=this.loadedBodies.every((e=>e))&&this.loadedJoints.every((e=>e))&&this.loadedImages.every((e=>e));return t?console.log("R.U.B.E. scene loaded successfully",this.loadedBodies,this.loadedJoints,this.loadedImages):console.error("R.U.B.E. scene failed to load fully",this.loadedBodies,this.loadedJoints,this.loadedImages),t}handleLoadImage(e,t){return console.log("handleLoadImage",e,t),null}loadBody(e){const t=new Q.b2BodyDef;t.set_type(Math.min(Math.max(e.type||0,0),2)),t.set_angle(e.angle||0),t.set_angularVelocity(e.angularVelocity||0),t.set_awake(Boolean(e.awake)),t.set_enabled(!e.hasOwnProperty("active")||Boolean(e.active)),t.set_fixedRotation(Boolean(e.fixedRotation)),t.set_linearVelocity(this.rubeToVec2(e.linearVelocity)),t.set_linearDamping(e.linearDamping||0),t.set_angularDamping(e.angularDamping||0),t.set_position(this.rubeToVec2(e.position)),t.set_bullet(Boolean(e.bullet||!1));const s=new Q.b2MassData;s.mass=e["massData-mass"]||1,s.center=this.rubeToVec2(e["massData-center"]),s.I=e["massData-I"]||1;const i=this.world.CreateBody(t);return i.SetMassData(s),Q.destroy(s),Q.destroy(t),this.customPropertiesArrayMap.set(i,e.customProperties||[]),this.customPropertiesMapMap.set(i,this.customPropertiesArrayToMap(e.customProperties||[])),(e.fixture||[]).forEach((e=>this.loadFixture(i,e))),i}loadFixture(e,t){const s=new Q.b2Filter;s.set_categoryBits(t["filter-categoryBits"]||1),s.set_maskBits(t["filter-maskBits"]||65535),s.set_groupIndex(t["filter-groupIndex"]||0);const i=this.getFixtureDefWithShape(t);i.set_friction(t.friction||0),i.set_density(t.density||0),i.set_restitution(t.restitution||0),i.set_isSensor(Boolean(t.sensor)),i.set_filter(s);const o=e.CreateFixture(i);return Q.destroy(i),Q.destroy(s),this.customPropertiesArrayMap.set(o,t.customProperties||[]),this.customPropertiesMapMap.set(o,this.customPropertiesArrayToMap(t.customProperties||[])),o}loadJoint(e){if(e.bodyA>=this.loadedBodies.length)return console.error("Index for bodyA is invalid: "+e),null;if(e.bodyB>=this.loadedBodies.length)return console.error("Index for bodyB is invalid: "+e),null;const t=this.loadedBodies[e.bodyA],s=this.loadedBodies[e.bodyB];if(!t||!s)return console.error("bodyA or bodyB are invalid",t,s,this.loadedBodies),null;let i;switch(e.type){case"revolute":{const o=new Q.b2RevoluteJointDef;o.Initialize(t,s,l.Add(l.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition())),o.collideConnected=Boolean(e.collideConnected),o.referenceAngle=e.refAngle||0,o.enableLimit=Boolean(e.enableLimit),o.lowerAngle=e.lowerLimit||0,o.upperAngle=e.upperLimit||0,o.enableMotor=Boolean(e.enableMotor),o.maxMotorTorque=e.maxMotorTorque||0,o.motorSpeed=e.motorSpeed||0,i=this.world.CreateJoint(o),Q.destroy(o);break}case"distance":{const o=new Q.b2DistanceJointDef;o.length=e.length||0,o.Initialize(t,s,l.Add(l.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition()),l.Add(l.Rotate(this.rubeToVec2(e.anchorB),s.GetAngle()),s.GetPosition())),o.collideConnected=Boolean(e.collideConnected),o.length=e.length||0,o.minLength=0,o.maxLength=2*o.length,this.setLinearStiffness(o,e.frequency||0,e.dampingRatio||0,o.bodyA,o.bodyB),i=this.world.CreateJoint(o),Q.destroy(o);break}case"prismatic":{const o=new Q.b2PrismaticJointDef;o.Initialize(t,s,l.Add(l.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition()),this.rubeToVec2(e.localAxisA)),o.collideConnected=Boolean(e.collideConnected),o.referenceAngle=e.refAngle||0,o.enableLimit=Boolean(e.enableLimit),o.lowerTranslation=e.lowerLimit||0,o.upperTranslation=e.upperLimit||0,o.enableMotor=Boolean(e.enableMotor),o.maxMotorForce=e.maxMotorForce||0,o.motorSpeed=e.motorSpeed||0,i=this.world.CreateJoint(o),Q.destroy(o);break}case"wheel":{const o=new Q.b2WheelJointDef;o.Initialize(t,s,this.rubeToVec2(e.anchorB),this.rubeToVec2(e.localAxisA)),o.collideConnected=Boolean(e.collideConnected),o.enableMotor=Boolean(e.enableMotor),o.maxMotorTorque=e.maxMotorTorque||0,o.motorSpeed=e.motorSpeed||0,this.setLinearStiffness(o,e.springFrequency||0,e.springDampingRatio||0,o.bodyA,o.bodyB),i=this.world.CreateJoint(o),Q.destroy(o);break}case"friction":{const o=new Q.b2FrictionJointDef;o.Initialize(t,s,l.Add(l.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition())),o.collideConnected=Boolean(e.collideConnected),o.maxForce=e.maxForce||0,o.maxTorque=e.maxTorque||0,i=this.world.CreateJoint(o),Q.destroy(o);break}case"weld":{const o=new Q.b2WeldJointDef;o.Initialize(t,s,l.Add(l.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition())),o.collideConnected=Boolean(e.collideConnected),o.referenceAngle=e.refAngle||0,this.setAngularStiffness(o,e.frequency||0,e.dampingRatio||0,o.bodyA,o.bodyB),i=this.world.CreateJoint(o),Q.destroy(o);break}default:throw new Error("Unsupported joint type: "+e.type)}return this.customPropertiesArrayMap.set(i,e.customProperties||[]),this.customPropertiesMapMap.set(i,this.customPropertiesArrayToMap(e.customProperties||[])),i}setLinearStiffness(e,t,s,i,o){const r=Q._malloc(2*Float32Array.BYTES_PER_ELEMENT);Q.b2LinearStiffness(r,r+Float32Array.BYTES_PER_ELEMENT,t||0,s||0,i,o);const[a,n]=Q.HEAPF32.subarray(r>>2);Q._free(r),e.stiffness=a,e.damping=n}setAngularStiffness(e,t,s,i,o){const r=Q._malloc(2*Float32Array.BYTES_PER_ELEMENT);Q.b2AngularStiffness(r,r+Float32Array.BYTES_PER_ELEMENT,t||0,s||0,i,o);const[a,n]=Q.HEAPF32.subarray(r>>2);Q._free(r),e.stiffness=a,e.damping=n}loadImage(e){const{body:t,customProperties:s}=e,i=this.loadedBodies[t],o=this.handleLoadImage(e,i);return o?(i&&this.bodyUserDataMap.set(i,o),o):null}rubeToVec2(e,t=new Q.b2Vec2(0,0)){return this.isXY(e)?t.Set(e.x,e.y):t.Set(0,0),t}getBodiesByName(e){const t=[];for(let s=this.world.GetBodyList();s;s=s.GetNext())s&&s.name===e&&t.push(s);return t}getBodiesByCustomProperty(e,t,s){const i=[];for(let o=this.world.GetBodyList();Q.getPointer(o)!==Q.getPointer(Q.NULL);o=o.GetNext()){const r=this.customPropertiesArrayMap.get(o);if(o&&r)for(const a of Object.values(r))a.hasOwnProperty("name")&&a.hasOwnProperty(e)&&a.name==t&&a[e]==s&&i.push(o)}return i}getFixturesByCustomProperty(e,t,s){const i=[];for(let o=this.world.GetBodyList();o;o=o.GetNext())for(let r=o.GetFixtureList();r;r=r.GetNext()){const o=this.customPropertiesArrayMap.get(r);if(r&&o)for(let a=0;a<o.length;a++)o[a].hasOwnProperty("name")&&o[a].hasOwnProperty(e)&&o[a].name==t&&o[a][e]==s&&i.push(r)}return i}getJointsByCustomProperty(e,t,s){const i=[];for(let o=this.world.GetJointList();Q.getPointer(o)!==Q.getPointer(Q.NULL);o=o.GetNext()){const r=this.customPropertiesArrayMap.get(o);if(o&&r)for(let a=0;a<r.length;a++)r[a].hasOwnProperty("name")&&r[a].hasOwnProperty(e)&&r[a].name==t&&r[a][e]==s&&i.push(o)}return i}getCustomProperty(e,t,s,i){const o=this.customPropertiesArrayMap.get(e);if(!o)return i;for(const e of Object.values(o))if(e.name&&e.hasOwnProperty(t)&&e.name===s)return e[t];return i}customPropertiesArrayToMap(e){return e.reduce(((e,t)=>{if(t.hasOwnProperty("int"))e[t.name]=t.int;else if(t.hasOwnProperty("float"))e[t.name]=t.float;else if(t.hasOwnProperty("string"))e[t.name]=t.string;else if(t.hasOwnProperty("color"))e[t.name]=t.color;else if(t.hasOwnProperty("bool"))e[t.name]=t.bool;else{if(!t.hasOwnProperty("vec2"))throw new Error("invalid or missing custom property type");e[t.name]=this.rubeToVec2(t.vec2)}return e}),{})}getFixtureDefWithShape(e){const t=new Q.b2FixtureDef;if(e.hasOwnProperty("circle")&&e.circle)t.shape=this.createCircleShape(e.circle);else if(e.hasOwnProperty("polygon")&&e.polygon)t.shape=this.createPolygonShape(e.polygon);else{if(!e.hasOwnProperty("chain")||!e.chain)throw new Error("Could not find shape type for fixture");t.shape=this.createChainShape(e.chain)}return t}createCircleShape(e){if(!e)throw new Error("fixtureJson.circle is missing");const t=new Q.b2CircleShape;return t.set_m_radius(e.radius),t.set_m_p(this.rubeToVec2(e.center)),t}createPolygonShape(e){if(!e)throw new Error("fixtureJson.polygon is missing");const t=this.pointsFromSeparatedVertices(e.vertices).reverse(),{_malloc:s,b2Vec2:i,b2PolygonShape:o,HEAPF32:r,wrapPointer:a}=Q,n=new o,l=s(8*t.length);let h=0;for(let e=0;e<t.length;e++)r[l+h>>2]=t[e].get_x(),r[l+(h+4)>>2]=t[e].get_y(),h+=8;const c=a(l,i);return n.Set(c,t.length),n}createChainShape(e){if(!e)throw new Error("fixtureJson.chain is missing");const t=this.pointsFromSeparatedVertices(e.vertices).reverse(),s=Boolean(e.hasNextVertex&&e.hasPrevVertex&&e.nextVertex&&e.prevVertex),{_malloc:i,b2Vec2:o,b2ChainShape:r,HEAPF32:a,wrapPointer:n}=Q,l=new r,h=i(8*t.length);let c=0;for(let e=0;e<t.length;e++)a[h+c>>2]=t[e].get_x(),a[h+(c+4)>>2]=t[e].get_y(),c+=8;const d=n(h,o);return s?l.CreateLoop(d,t.length):l.CreateChain(d,t.length,this.rubeToVec2(e.prevVertex),this.rubeToVec2(e.nextVertex)),l}pointsFromSeparatedVertices(e){const t=[];for(let s=0;s<e.x.length;s++)t.push(new Q.b2Vec2(e.x[s],e.y[s]));return t}isXY(e){return Boolean(e&&"object"==typeof e&&e.hasOwnProperty("x")&&e.hasOwnProperty("y"))}}const d=2*Float32Array.BYTES_PER_ELEMENT;class u{constructor(e,t,s=2){this.instance=new Q.JSDraw,this.graphics=e,this.pixelsPerMeter=t,this.lineWidth=s,this.instance.AppendFlags(Q.b2Draw.e_shapeBit),this.instance.AppendFlags(Q.b2Draw.e_centerOfMassBit),this.instance.DrawSegment=(e,t,s)=>{const i=Q.wrapPointer(e,Q.b2Vec2),o=Q.wrapPointer(t,Q.b2Vec2),r=Q.wrapPointer(s,Q.b2Color),a=(new Phaser.Display.Color).setGLTo(r.r,r.g,r.b,1);this.graphics.lineStyle(this.lineWidth,a.color,1),this.graphics.lineBetween(i.x*this.pixelsPerMeter,-i.y*this.pixelsPerMeter,o.x*this.pixelsPerMeter,-o.y*this.pixelsPerMeter)},this.instance.DrawPolygon=(e,t,s)=>{const i=Q.wrapPointer(s,Q.b2Color),o=[];for(let s=0;s<t;s++)o.push(Q.wrapPointer(e+s*d,Q.b2Vec2));const r=(new Phaser.Display.Color).setGLTo(i.r,i.g,i.b,1);this.graphics.lineStyle(this.lineWidth,r.color,1),this.graphics.strokePoints(o.map((e=>new Phaser.Math.Vector2(e.x*this.pixelsPerMeter,-e.y*this.pixelsPerMeter))),!0,!0)},this.instance.DrawCircle=(e,t,s)=>{const i=Q.wrapPointer(e,Q.b2Vec2),o=Q.wrapPointer(s,Q.b2Color),r=(new Phaser.Display.Color).setGLTo(o.r,o.g,o.b,1);this.graphics.lineStyle(this.lineWidth,r.color,1),this.graphics.strokeCircle(i.x*this.pixelsPerMeter,-i.y*this.pixelsPerMeter,t*this.pixelsPerMeter)},this.instance.DrawPoint=(e,t,s)=>{const i=Q.wrapPointer(e,Q.b2Vec2),o=Q.wrapPointer(s,Q.b2Color),r=(new Phaser.Display.Color).setGLTo(o.r,o.g,o.b,1);this.graphics.lineStyle(this.lineWidth,r.color,1),this.graphics.strokeCircle(i.x*this.pixelsPerMeter,-i.y*this.pixelsPerMeter,t)},this.instance.DrawSolidPolygon=(e,t,s)=>this.instance.DrawPolygon(e,t,s),this.instance.DrawSolidCircle=(e,t,s,i)=>this.instance.DrawCircle(e,t,i),this.instance.DrawTransform=e=>{}}clear(){setTimeout((()=>this.graphics.clear()),0)}}class p extends Phaser.Events.EventEmitter{constructor(e,t,s){super(),this.isPaused=!1,this.stepDeltaTime=1/60,this.stepConfig={positionIterations:12,velocityIterations:12},this.debugDraw=e.add.graphics(),this.scene=e,this.worldScale=t;const i=new Q.b2Vec2(s.x,s.y);this.world=new Q.b2World(i),this.world.SetAutoClearForces(!0),this.debugDrawer=new u(this.scene.add.graphics().setDepth(5e3),this.worldScale),this.world.SetDebugDraw(this.debugDrawer.instance);const o=new Q.JSContactListener;o.BeginContact=e=>{const t=Q.wrapPointer(e,Q.b2Contact),s=t.GetFixtureA(),i=t.GetFixtureB(),o=s.GetBody(),r=i.GetBody(),a={contact:t,fixtureA:s,fixtureB:i,bodyA:o,bodyB:r};this.emit("begin_contact",a)},o.EndContact=()=>null,o.PreSolve=()=>null,o.PostSolve=(e,t)=>{const s=Q.wrapPointer(e,Q.b2Contact),i=Q.wrapPointer(t,Q.b2ContactImpulse),o=s.GetFixtureA(),r=s.GetFixtureB(),a=o.GetBody(),n=r.GetBody(),l={contact:s,impulse:i,fixtureA:o,fixtureB:r,bodyA:a,bodyB:n};this.emit("post_solve",l)},this.world.SetContactListener(o),Q.destroy(i),this.rubeLoader=new c(this.world),this.rubeLoader.handleLoadImage=(e,t)=>{const{file:s,center:i,customProperties:o,angle:r,aspectScale:a,scale:n,flip:l,renderOrder:h}=e,c=t?t.GetPosition():this.rubeLoader.rubeToVec2(i);if(!c)return null;const d=this.rubeLoader.customPropertiesArrayToMap(o||[]),u=(s||"").split("/").reverse()[0],p=d.phaserTexture||u,m=d.phaserTextureFrame||u,y=this.scene.add.image(c.x*this.worldScale,c.y*-this.worldScale,p,m);return y.rotation=t?-t.GetAngle()-(r||0):-(r||0),y.scaleY=this.worldScale/y.height*n,y.scaleX=y.scaleY*a,y.alpha=e.opacity||1,y.flipX=l,y.setDepth(h),y.setDataEnabled(),y.data.set("angle_offset",-(r||0)),this.rubeLoader.customPropertiesArrayMap.set(y,o||[]),this.rubeLoader.customPropertiesMapMap.set(y,d),y}}loadRubeScene(e){const t=this.scene.cache.json.get(e);if(!this.rubeLoader.loadScene(t))throw new Error("Failed to load RUBE scene");console.log("RUBE scene loaded successfully.")}update(){if(this.isPaused)return;this.world.Step(this.stepDeltaTime,this.stepConfig.positionIterations,this.stepConfig.positionIterations);const e=this.worldScale;for(let t=this.world.GetBodyList();Q.getPointer(t)!==Q.getPointer(Q.NULL);t=t.GetNext()){if(!t)continue;const s=this.rubeLoader.bodyUserDataMap.get(t);if(s)if(t.IsEnabled()){let i=t.GetPosition();s.setVisible(!0),s.x=i.x*e,s.y=-i.y*e,s.rotation=-t.GetAngle()+(s.data.get("angle_offset")||0)}else s.visible=!1}}}class m{constructor(e){this.segments=[],this.player=e,this.scene=e.scene,this.b2Physics=e.b2Physics,this.ZERO=new Q.b2Vec2(0,0),this.debugGraphics=this.scene.add.graphics().setDepth(1e7),this.debugGraphics.fillStyle(16777215,1),this.debugGraphics.fillCircle(8,8,8),this.debugGraphics.generateTexture("circle_01",16,16),this.debugGraphics.clear(),this.initRays(this.b2Physics.worldScale/4),this.particles=this.scene.add.particles(0,0,"circle_01",{active:!0,visible:!0,emitting:!1,particleBringToTop:!0,radial:!0,blendMode:0,gravityY:100,delay:100,frequency:0,maxParticles:0,timeScale:1,alpha:1,angle:{min:0,max:360},lifespan:{min:600,max:1250},quantity:{min:2,max:10},scale:{ease:"Linear",min:.1,max:.25},speed:{min:25,max:100}}).setDepth(-10);const t=this.b2Physics.rubeLoader.customPropertiesMapMap,s=this.b2Physics.worldScale;this.b2Physics.on("post_solve",(({contact:e,impulse:i,bodyA:o,bodyB:r})=>{const a=t.get(o),n=t.get(r);if(a&&"snow"!==a.surfaceType&&n&&"snow"!==n.surfaceType)return;const h=(a&&"snow"!==a.surfaceType?o:r).GetLinearVelocity().Length(),c=new Q.b2WorldManifold;e.GetWorldManifold(c);for(let e=0;e<i.get_count();e++){const t=l.Scale(c.get_points(e),s,-s),o=i.get_normalImpulses(e);if(this.scene.cameras.main.worldView.contains(t.x,t.y)&&!(o<4||h<.5)&&(this.particles.emitParticleAt(t.x,t.y,Math.min(1.5*o,25)),a&&"boardSegment"===a.phaserPlayerCharacterPart||n&&"boardSegment"===n.phaserPlayerCharacterPart)){const e=this.segments[3].groundRayResult.hit;this.scene.observer.emit("surface_impact",o,"snow",!1,e,!1)}}}))}update(){const e=this.segments;for(const e of this.segments){this.resetSegment(e);const t=l.Clone(e.body.GetWorldPoint(this.ZERO)),s=l.Clone(e.body.GetWorldPoint(e.groundRayDirection));this.b2Physics.world.RayCast(e.groundRayCallback,t,s)}this.isTailGrounded=e[0].groundRayResult.hit,this.isNoseGrounded=e[e.length-1].groundRayResult.hit,this.isCenterGrounded=e[3].groundRayResult.hit}getFramesInAir(){if(this.segments.some((e=>e.groundRayResult.hit)))return-1;let e=0;for(const t of this.segments)e=Math.max(e,t.groundRayResult.lastHitFrame);return this.scene.game.getFrame()-e}isInAir(){return-1!==this.getFramesInAir()}resetSegment(e){e.groundRayResult.hit=!1,e.groundRayResult.point.SetZero(),e.groundRayResult.normal.SetZero(),e.groundRayResult.fraction=-1}initRays(e){const t=new Q.b2Vec2(0,-e/this.b2Physics.worldScale);for(const e of this.player.parts.boardSegments){const s={hit:!1,point:new Q.b2Vec2(0,0),normal:new Q.b2Vec2(0,0),fraction:-1,lastHitFrame:-1},i=new Q.JSRayCastCallback;i.ReportFixture=(e,t,i,o)=>{if(Q.wrapPointer(e,Q.b2Fixture).IsSensor())return-1;const{x:r,y:a}=Q.wrapPointer(t,Q.b2Vec2),{x:n,y:l}=Q.wrapPointer(i,Q.b2Vec2);return s.hit=!0,s.point.Set(r,a),s.normal.Set(n,l),s.fraction=o,s.lastHitFrame=this.scene.game.getFrame(),o},this.segments.push({body:e,groundRayDirection:t,groundRayResult:s,groundRayCallback:i})}}}const y=()=>{const e=localStorage.getItem(F);return e&&O.includes(e)?e:G.level_001};class g{constructor(e){this.levelFinished=!1,this.isCrashed=!1,this.timeGrounded=0,this.pickupsToProcess=new Set,this.seenSensors=new Set,this.comboLeeway=null,this.comboAccumulatedScore=0,this.comboMultiplier=0,this.totalTrickScore=0,this.totalCollectedPresents=0,this.trickScoreLog=[],this.anglePreviousUpdate=0,this.totalRotation=0,this.currentFlipRotation=0,this.pendingFrontFlips=0,this.pendingBackFlips=0,this.landedFrontFlips=0,this.landedBackFlips=0,this.lastDistance=0,this.parts=e.parts,this.playerController=e,this.b2Physics=e.b2Physics,this.state=e.board.isInAir()?"in_air":"grounded",this.registerCollisionListeners(),this.playerController.scene.observer.on("enter_in_air",(()=>this.state="in_air")),this.playerController.scene.observer.on("enter_grounded",(()=>{this.state="grounded",this.timeGrounded=this.playerController.scene.game.getFrame(),this.landedFrontFlips+=this.pendingFrontFlips,this.landedBackFlips+=this.pendingBackFlips;const e=this.pendingBackFlips+this.pendingFrontFlips;if(e>=1){this.trickScoreLog.push({type:"flip",flips:e,timestamp:Date.now()});const t=e*e*K;this.totalTrickScore+=t,this.comboAccumulatedScore+=t*W,this.comboMultiplier++,this.playerController.scene.observer.emit("combo_change",this.comboAccumulatedScore,this.comboMultiplier),this.playerController.scene.observer.emit("score_change",this.getCurrentScore()),this.resetComboLeewayTween(),this.comboLeeway=this.createComboLeewayTween(!1)}this.totalRotation=0,this.currentFlipRotation=0,this.pendingBackFlips=0,this.pendingFrontFlips=0}))}getCurrentSpeed(){return this.parts.body.GetLinearVelocity().Length()}createComboLeewayTween(e=!0){return this.playerController.scene.tweens.addCounter({paused:e,from:-.5*Math.PI,to:1.5*Math.PI,duration:4e3,onUpdate:e=>this.playerController.scene.observer.emit("combo_leeway_update",e.getValue()),onComplete:e=>this.handleComboComplete()})}reset(){this.totalTrickScore=0,this.trickScoreLog=[],this.comboLeeway&&(this.comboLeeway.stop(),this.comboLeeway=null),this.totalCollectedPresents=0,this.comboMultiplier=0,this.comboAccumulatedScore=0,this.levelFinished=!1,this.isCrashed=!1,this.seenSensors.clear(),this.pickupsToProcess.clear(),this.pendingFrontFlips=0,this.pendingBackFlips=0,this.landedBackFlips=0,this.landedFrontFlips=0,this.currentFlipRotation=0,this.anglePreviousUpdate=0,this.lastDistance=0,this.timeGrounded=0,this.totalRotation=0}getCurrentScore(){return{distance:this.getTravelDistanceMeters(),coins:this.totalCollectedPresents,trickScore:this.totalTrickScore,finishedLevel:this.levelFinished,crashed:this.isCrashed,trickScoreLog:this.trickScoreLog,level:y()}}getState(){return this.state}getTravelDistanceMeters(){const e=this.parts.body.GetPosition().x;return 5*Math.floor(e/5)}registerCollisionListeners(){this.b2Physics.on("post_solve",(({fixtureA:e,fixtureB:t,impulse:s})=>{if(this.isCrashed)return;const i=e.GetBody(),o=t.GetBody();if(i===o)return;let r=-1;for(let e=0;e<s.count;e++)r=Math.max(r,s.get_normalImpulses(e));(i===this.parts.head||o===this.parts.head)&&r>Y&&this.setCrashed()}));const e=this.b2Physics.rubeLoader.customPropertiesMapMap;this.b2Physics.on("begin_contact",(({bodyA:t,bodyB:s,fixtureA:i,fixtureB:o})=>{var r,a;i.IsSensor()&&!this.seenSensors.has(t)&&(null===(r=e.get(i))||void 0===r?void 0:r.phaserSensorType)?this.handleSensor(t,i):o.IsSensor()&&!this.seenSensors.has(s)&&(null===(a=e.get(o))||void 0===a?void 0:a.phaserSensorType)&&this.handleSensor(s,o)}))}setCrashed(){this.isCrashed=!0,this.playerController.scene.observer.emit("enter_crashed",this.getCurrentScore()),this.resetComboLeewayTween()}handleSensor(e,t){var s;if(this.seenSensors.add(e),!this.isCrashed&&!this.levelFinished)switch(null===(s=this.b2Physics.rubeLoader.customPropertiesMapMap.get(t))||void 0===s?void 0:s.phaserSensorType){case"pickup_present":this.pickupsToProcess.add(e);break;case"level_finish":{this.playerController.scene.cameras.main.stopFollow(),this.handleComboComplete(),this.levelFinished=!0,this.resetComboLeewayTween();const e=this.getCurrentScore();this.playerController.scene.observer.emit("score_change",e),this.playerController.scene.observer.emit("level_finish",e);break}case"level_deathzone":this.setCrashed()}}update(){this.processPickups();const e=this.playerController.board.isInAir();"grounded"===this.state&&e&&!this.isCrashed?this.playerController.scene.observer.emit("enter_in_air"):"in_air"!==this.state||e||this.isCrashed||this.playerController.scene.observer.emit("enter_grounded"),this.updateTrickCounter(),this.updateComboLeeway(),this.updateDistance()}processPickups(){for(const e of this.pickupsToProcess){const t=this.b2Physics.rubeLoader.bodyUserDataMap.get(e);this.b2Physics.rubeLoader.bodyUserDataMap.delete(e),this.b2Physics.world.DestroyBody(e),t.destroy(),this.totalCollectedPresents++,this.playerController.scene.observer.emit("pickup_present",this.totalCollectedPresents),this.playerController.scene.observer.emit("score_change",this.getCurrentScore())}this.pickupsToProcess.clear()}updateTrickCounter(){if("in_air"===this.state){const e=o.Math.Angle.Normalize(this.parts.body.GetAngle()),t=this.calculateDifferenceBetweenAngles(this.anglePreviousUpdate,e);this.totalRotation+=t,this.currentFlipRotation+=t,this.anglePreviousUpdate=e,this.currentFlipRotation>=Math.PI*(0===this.pendingBackFlips?1.25:2)?(this.pendingBackFlips++,this.currentFlipRotation=0):this.currentFlipRotation<=Math.PI*-(0===this.pendingFrontFlips?1.25:2)&&(this.pendingFrontFlips++,this.currentFlipRotation=0)}}updateComboLeeway(){this.comboLeeway&&("in_air"===this.state||!this.playerController.board.isCenterGrounded||this.b2Physics.isPaused?this.comboLeeway.isPlaying()&&this.comboLeeway.pause():this.comboLeeway.isPaused()&&this.comboLeeway.resume())}resetComboLeewayTween(){this.comboLeeway&&(this.comboLeeway.stop(),this.comboLeeway=null)}calculateDifferenceBetweenAngles(e,t){let s=t-e;return s<-Math.PI?s+=2*Math.PI:s>Math.PI&&(s-=2*Math.PI),s}updateDistance(){const e=this.getTravelDistanceMeters();e===this.lastDistance||this.isCrashed||this.levelFinished||(this.playerController.scene.observer.emit("distance_change",e),this.playerController.scene.observer.emit("score_change",this.getCurrentScore()),this.lastDistance=e)}handleComboComplete(){if(this.levelFinished)return;const e=this.comboAccumulatedScore*this.comboMultiplier;this.totalTrickScore+=e,this.trickScoreLog.push({type:"combo",multiplier:this.comboMultiplier,accumulator:this.comboAccumulatedScore,timestamp:Date.now()}),this.playerController.scene.observer.emit("score_change",this.getCurrentScore()),this.playerController.scene.observer.emit("combo_change",0,0),this.comboAccumulatedScore=0,this.comboMultiplier=0}}const b=(e,t=!0)=>e.distance+w(e,t)+e.coins*j+(e.finishedLevel?J:0),w=(e,t)=>t?e.trickScore:e.trickScoreLog.reduce(((e,t)=>"combo"===t.type?e+t.multiplier*t.accumulator:"flip"===t.type?e+t.flips*t.flips*K:e),0),f=()=>Math.random().toString(36).slice(2);var P,v,S=function(e,t,s,i){return new(s||(s=Promise))((function(o,r){function a(e){try{l(i.next(e))}catch(e){r(e)}}function n(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,n)}l((i=i.apply(e,t||[])).next())}))};!function(e){e.PANEL_PAUSE_MENU="panel-pause-menu",e.PANEL_SELECT_LEVEL="panel-select-level",e.PANEL_LEADERBOARDS="panel-leaderboards",e.PANEL_HOW_TO_PLAY="panel-how-to-play",e.PANEL_SETTINGS="panel-settings",e.PANEL_CREDITS="panel-credits",e.PANEL_YOUR_SCORE="panel-your-score",e.NONE="none"}(P||(P={})),function(e){e.HUD_DISTANCE="hud-distance",e.HUD_COMBO="hud-combo",e.HUD_SCORE="hud-score"}(v||(v={}));class L extends o.Scene{constructor(){super({key:"GameUIScene"}),this.panels=[],this.pendingScore=null,this.localScores=[],this.crashed=!1,this.finished=!1}init([e,t]){this.observer=e,this.restartGame=t,this.resolutionMod=this.game.canvas.width/q}create(){const e=Number(localStorage.getItem(k)||80)/100,t=Object.values(V)[Math.floor(Math.random()*Object.values(V).length)];this.music=this.sound.add(t,{loop:!0,volume:1*e,rate:1,delay:1,detune:0}),this.music.play();const s=Number(localStorage.getItem(I)||80)/100;this.sfx_jump_start=this.sound.add("boink",{detune:-200,volume:s}),this.sfx_pickup_present=this.sound.add("pickup_present",{detune:0,rate:1,volume:.6*s}),this.sfx_death=this.sound.add("death",{detune:700,rate:1.25,volume:.8*s}),this.sfx_grunt=this.sound.add("grunt",{detune:400,rate:1.25,volume:.5*s}),this.sfx_applause=this.sound.add("applause",{detune:0,rate:1,volume:.6*s}),this.sfx_game_over_demon=this.sound.add("game_over_demon",{detune:0,rate:.95,volume:.6*s});const i=this.cameras.main.worldView.x+this.cameras.main.width/2;this.cameras.main.worldView.y,this.cameras.main.height,B.setLevel(y()),this.initDomUi(),this.observer.on("toggle_pause",((e,t)=>this.setPanelVisibility(e?t:P.NONE))),this.observer.on("pickup_present",(e=>{this.hudDistance&&(this.hudDistance.innerText=String(e)+"x"),this.sfx_pickup_present.play()})),this.observer.on("combo_change",((e,t)=>{this.hudCombo&&(this.hudCombo.innerText=e?e+"x"+t:"-")})),this.observer.on("score_change",(e=>{this.hudScore&&(this.hudScore.innerText=String(b(e)))})),this.comboLeewayChart=this.add.graphics(),this.observer.on("combo_leeway_update",(e=>{this.comboLeewayChart.clear().fillStyle(16777215).slice(i,72*this.resolutionMod,12*this.resolutionMod,e,1.5*Math.PI).fillPath()})),this.observer.on("enter_crashed",(e=>{this.pendingScore=e,this.crashed=!0,this.sfx_death.play(),this.sfx_grunt.play(),this.finished||(this.comboLeewayChart.clear(),this.hudCombo&&(this.hudCombo.innerText="-"),this.sfx_game_over_demon.play(),this.tweens.add({targets:this.music,volume:0,detune:-500,rate:.5,duration:750,onComplete:()=>S(this,void 0,void 0,(function*(){this.music.stop(),yield this.updateYourScorePanelData(e),this.setPanelVisibility(P.PANEL_YOUR_SCORE)}))}))})),this.observer.on("level_finish",(e=>{this.crashed||(this.pendingScore=e,this.finished=!0,this.sfx_applause.play(),this.comboLeewayChart.clear(),this.tweens.add({targets:this.music,volume:0,duration:2e3,onComplete:()=>S(this,void 0,void 0,(function*(){this.music.stop(),yield this.updateYourScorePanelData(e),this.setPanelVisibility(P.PANEL_YOUR_SCORE)}))}))}))}update(){}initDomUi(){const e=this.cameras.main.worldView.x+this.cameras.main.width/2,t=this.cameras.main.worldView.y+this.cameras.main.height/2,s=this.add.dom(e,t).createFromCache("dom_game_ui");s.setScale(this.resolutionMod).addListener("click");const i=localStorage.getItem(M)||"1",o=Array.from(document.querySelectorAll('#settings-form input[name="resolution"]'));for(const e of o)e.value===i&&(e.checked=!0);const r=localStorage.getItem(k)||"80",a=document.querySelector('#settings-form input[name="volumeMusic"]');a&&(a.value=r);const n=localStorage.getItem(I)||"80",l=document.querySelector('#settings-form input[name="volumeSfx"]');l&&(l.value=n);const h=this.sys.game.device.browser;if(!(h.chrome||h.edge||h.opera)){const e=document.getElementById("unsupported-browser-notice");if(!e)throw new Error('element with id "unsupported-browser-notice" not found');console.warn("Unsupported browser detected. Game may run well but it was not optimized for this particular browser:",h),e.classList.remove("hidden")}const c=document.getElementById("pause-game-icon"),d=document.getElementById("how-to-play-icon");if(c&&d&&setTimeout((()=>{c.classList.remove("hidden"),d.classList.remove("hidden")}),250),this.panelPauseMenu=document.getElementById(P.PANEL_PAUSE_MENU),this.panelSelectLevel=document.getElementById(P.PANEL_SELECT_LEVEL),this.panelHowToPlay=document.getElementById(P.PANEL_HOW_TO_PLAY),this.panelLeaderboards=document.getElementById(P.PANEL_LEADERBOARDS),this.panelSettings=document.getElementById(P.PANEL_SETTINGS),this.panelCredits=document.getElementById(P.PANEL_CREDITS),this.panelYourScore=document.getElementById(P.PANEL_YOUR_SCORE),this.hudDistance=document.getElementById(v.HUD_DISTANCE),this.hudCombo=document.getElementById(v.HUD_COMBO),this.hudScore=document.getElementById(v.HUD_SCORE),!this.panelPauseMenu)throw new Error("panelPauseMenu not found");if(!this.panelSelectLevel)throw new Error("panelSelectLevel not found");if(!this.panelHowToPlay)throw new Error("panelHowToPlay not found");if(!this.panelLeaderboards)throw new Error("panelLeaderboards not found");if(!this.panelSettings)throw new Error("panelSettings not found");if(!this.panelCredits)throw new Error("panelCredits not found");if(!this.panelYourScore)throw new Error("panelYourScore not found");if(!this.hudDistance)throw new Error("hudDistance not found");if(!this.hudCombo)throw new Error("hudCombo not found");if(!this.hudScore)throw new Error("hudScore not found");return this.panels=[this.panelPauseMenu,this.panelSelectLevel,this.panelHowToPlay,this.panelLeaderboards,this.panelSettings,this.panelCredits,this.panelYourScore],s.on("click",(e=>S(this,void 0,void 0,(function*(){var t,s,i,o;switch(e.target.id){case"btn-goto-pause-menu":this.setPanelVisibility(P.PANEL_PAUSE_MENU);break;case"btn-resume-game":this.setPanelVisibility(P.NONE),this.observer.emit("resume_game");break;case"btn-goto-select-level":{const e=document.querySelector("#panel-select-level #btn-goto-pause-menu");e&&(this.crashed?e.classList.add("hidden"):e.classList.remove("hidden")),this.setPanelVisibility(P.PANEL_SELECT_LEVEL);break}case"btn-goto-how-to-play":this.setPanelVisibility(P.PANEL_HOW_TO_PLAY);break;case"btn-goto-leaderboards":yield this.updateLeaderboardPanelData(),this.setPanelVisibility(P.PANEL_LEADERBOARDS);break;case"btn-goto-settings":this.setPanelVisibility(P.PANEL_SETTINGS);break;case"btn-goto-credits":this.setPanelVisibility(P.PANEL_CREDITS);break;case"pause-game-icon":(null===(t=this.panelPauseMenu)||void 0===t?void 0:t.classList.contains("hidden"))&&this.observer.emit("pause_game_icon_pressed");break;case"how-to-play-icon":(null===(s=this.panelPauseMenu)||void 0===s?void 0:s.classList.contains("hidden"))&&this.observer.emit("how_to_play_icon_pressed");break;case"btn-score-submit":{const e=document.querySelector(".submit-score"),t=document.getElementById("username");(null==t?void 0:t.value)&&this.pendingScore&&e&&((null===(i=B.auth)||void 0===i?void 0:i.currentUser)&&(B.rexLeaderboard.setUser({userID:B.auth.currentUser.uid,userName:t.value}),yield B.auth.currentUser.updateProfile({displayName:t.value})),localStorage.setItem(T,t.value),yield B.submit(this.pendingScore),yield this.updateYourScorePanelData(this.pendingScore),e.classList.add("hidden"));break}case"btn-save-settings":{e.preventDefault();const t=null===(o=this.panelSettings)||void 0===o?void 0:o.querySelector("form");t&&(localStorage.setItem(M,t.resolution.value||"1"),localStorage.setItem(k,t.volumeMusic.value),localStorage.setItem(I,t.volumeSfx.value),location.reload());break}case"btn-play-again":this.playAgain();break;case"level_001":case"level_002":case"level_003":case"level_004":localStorage.setItem(F,e.target.id),B.setLevel(e.target.id),this.playAgain();break;default:Z&&console.log("non-interactable target id",e.target.id)}})))),s}playAgain(){this.music.stop(),this.sfx_game_over_demon.stop(),this.crashed=!1,this.finished=!1,this.restartGame()}setPanelVisibility(e){const t=document.getElementById("pause-game-icon"),s=document.getElementById("how-to-play-icon");t&&s&&(e===P.NONE?(t.classList.remove("hidden"),s.classList.remove("hidden")):(t.classList.add("hidden"),s.classList.add("hidden"))),this.panels.forEach((t=>{t.id===e?t.classList.remove("hidden"):t.classList.add("hidden")}))}updateYourScorePanelData(e){var t;return S(this,void 0,void 0,(function*(){if(this.panelYourScore){const s=document.getElementById("your-score-distance"),i=document.getElementById("your-score-coins"),o=document.getElementById("your-score-trick-score"),r=document.getElementById("your-score-bonus"),a=document.getElementById("your-score-best-combo"),n=document.getElementById("your-score-total"),l=document.getElementById("username"),h=document.querySelector(".submit-score");e.finishedLevel?this.panelYourScore.classList.add("succeeded"):this.panelYourScore.classList.remove("succeeded");const c=e.trickScoreLog.filter((e=>"combo"===e.type)),d=c.length?Math.max(...c.map((e=>e.accumulator*e.multiplier))):0;s&&(s.innerText=String(e.distance)+"m"),i&&(i.innerText=`${e.coins}x${j}`),o&&(o.innerText=String(e.trickScore)),r&&(r.innerText=String(e.finishedLevel?J:0)),a&&(a.innerText=String(d)),n&&(n.innerText=String(b(e)));const u=null===(t=B.auth)||void 0===t?void 0:t.currentUser;if(!u)return void(localStorage.getItem(T)?(null==h||h.classList.add("hidden"),yield B.submit(e)):(l.value=`Player_${f()}`,l.setAttribute("value",l.value),localStorage.setItem(T,l.value)));if(!l)throw new Error("username input field not found");const p=document.querySelector(".submit-score-offline-info");if(p&&p.classList.add("hidden"),u.displayName){null==h||h.classList.add("hidden"),B.rexLeaderboard.setUser({userID:u.uid,userName:u.displayName}),yield B.submit(e);const t=(yield B.rexLeaderboard.loadFirstPage()).map((e=>Object.assign(Object.assign({},e),{total:b(e,!1)}))).sort(((e,t)=>Number(t.total)-Number(e.total))),s=t.findIndex((e=>e.userID===u.uid)),i=document.getElementById("your-score-rank-value");i&&-1!==s&&(null==t?void 0:t.length)&&(i.innerText=`${s+1}/${t.length}`)}else l.value=`Player_${f()}`,l.setAttribute("value",l.value),localStorage.setItem(T,l.value)}}))}updateLeaderboardPanelData(){var e,t,s,i,o;return S(this,void 0,void 0,(function*(){if(null===(e=B.auth)||void 0===e?void 0:e.currentUser){const e=document.querySelector(".leaderboard-note");e&&e.classList.add("hidden")}let r=B.auth?yield B.rexLeaderboard.loadFirstPage():(JSON.parse(localStorage.getItem(R)||"{}")[y()]||[]).map((e=>Object.assign(Object.assign({},e),{userName:localStorage.getItem(T)})));const a=document.getElementById("leaderboard-item-template"),n=document.getElementById("leaderboard-item-container");if(this.panelLeaderboards&&a&&n){const e=(null===(s=null===(t=B.auth)||void 0===t?void 0:t.currentUser)||void 0===s?void 0:s.displayName)||localStorage.getItem(T),l=r.map((e=>Object.assign(Object.assign({},e),{total:b(e,!1)}))).sort(((e,t)=>Number(t.total)-Number(e.total)));n.innerText="";for(const[t,s]of l.entries()){const r=s.userName,l=a.content.cloneNode(!0),h=l.querySelector("#leaderboard-item-rank"),c=l.querySelector("#leaderboard-item-username"),d=l.querySelector("#leaderboard-item-score");h&&(h.innerHTML=String(t+1)),c&&(c.innerHTML=String(r)),d&&(d.innerHTML=String(b(s))),!c||!e||(null===(o=null===(i=B.auth)||void 0===i?void 0:i.currentUser)||void 0===o?void 0:o.uid)!==s.userID&&B.auth||c.classList.add("your-own-score"),n.appendChild(l)}}}))}}class _{constructor(e,t){this.jumpForce=13,this.leanForce=2.75,this.jumpCooldown=15,this.jumpKeyDownStartFrame=0,this.alreadyDetached=!1,this.currentBodyFlipDot=1,this.scene=e,this.b2Physics=t,this.scene.observer.on("pause_game_icon_pressed",(()=>this.pauseGame())),this.scene.observer.on("how_to_play_icon_pressed",(()=>this.pauseGame(P.PANEL_HOW_TO_PLAY))),this.scene.observer.on("resume_game",(()=>this.b2Physics.isPaused=!1)),this.initBodyParts(),this.board=new m(this),this.state=new g(this),this.initKeyboardInputs()}initKeyboardInputs(){if(!this.scene.input.keyboard)throw new Error("Keyboard input not available. No touch input supported yet.");this.keySpace=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),this.keyW=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),this.keyA=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),this.keyS=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S),this.keyD=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),this.keyArrowUp=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),this.keyArrowLeft=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),this.keyArrowRight=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),this.keyArrowDown=this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),this.keySpace.onDown=()=>this.pauseGame();const e=()=>{this.jumpKeyDown=!0,this.state.isCrashed||this.state.levelFinished||this.b2Physics.isPaused||"grounded"!==this.state.getState()||(this.jumpKeyDownStartFrame=this.scene.game.getFrame(),this.scene.observer.emit("jump_start"))};this.keyW.onDown=e,this.keyArrowUp.onDown=e,this.keyW.onUp=()=>this.jumpKeyDown=!1,this.keyArrowUp.onUp=()=>this.jumpKeyDown=!1}pauseGame(e=P.PANEL_PAUSE_MENU){this.state.isCrashed||this.state.levelFinished||(this.b2Physics.isPaused=!this.b2Physics.isPaused,this.state.updateComboLeeway(),this.scene.observer.emit("toggle_pause",this.b2Physics.isPaused,e))}update(){this.b2Physics.isPaused||(this.state.update(),this.board.getFramesInAir()>6&&!this.jumpKeyDown&&this.resetLegs(),this.state.isCrashed&&!this.alreadyDetached&&this.detachBoard(),this.state.isCrashed||this.state.levelFinished||(this.board.update(),this.applyInputs(),this.updateLookAtDirection()))}applyInputs(){this.jumpKeyDown&&this.scene.game.getFrame()-this.jumpKeyDownStartFrame<=this.jumpCooldown&&this.jump(),this.jumpKeyDown&&this.leanUp(),(this.keyArrowLeft.isDown||this.keyA.isDown)&&this.leanBackward(),(this.keyArrowRight.isDown||this.keyD.isDown)&&this.leanForward(),(this.keyArrowDown.isDown||this.keyS.isDown)&&this.leanCenter()}updateLookAtDirection(){const e=l.Normalize(l.Clone(this.parts.body.GetLinearVelocity())),t=l.Normalize(this.parts.body.GetWorldVector(new Q.b2Vec2(1,0))),s="grounded"===this.state.getState()?.03:.01,i=l.Dot(t,e)<0?-1:1;this.currentBodyFlipDot=this.currentBodyFlipDot+s*(i-this.currentBodyFlipDot);const o=this.b2Physics.rubeLoader.bodyUserDataMap.get(this.parts.head),r=this.b2Physics.rubeLoader.bodyUserDataMap.get(this.parts.body),a=this.b2Physics.rubeLoader.bodyUserDataMap.get(this.parts.armUpperLeft),n=this.b2Physics.rubeLoader.bodyUserDataMap.get(this.parts.armUpperRight),h=this.b2Physics.rubeLoader.bodyUserDataMap.get(this.parts.armLowerLeft),c=this.b2Physics.rubeLoader.bodyUserDataMap.get(this.parts.armLowerRight);this.currentBodyFlipDot<0?(o.flipX=!0,r.flipX=!0,a.setDepth(this.parts.armUpperRightRenderDepth),n.setDepth(this.parts.armUpperLeftRenderDepth),h.setDepth(this.parts.armLowerRightRenderDepth),c.setDepth(this.parts.armLowerLeftRenderDepth)):(o.flipX=!1,r.flipX=!1,a.setDepth(this.parts.armUpperLeftRenderDepth),n.setDepth(this.parts.armUpperRightRenderDepth),h.setDepth(this.parts.armLowerLeftRenderDepth),c.setDepth(this.parts.armLowerRightRenderDepth))}detachBoard(){this.parts.bindingLeft&&this.b2Physics.world.DestroyJoint(Q.getPointer(this.parts.bindingLeft)),this.parts.bindingRight&&this.b2Physics.world.DestroyJoint(Q.getPointer(this.parts.bindingRight)),this.parts.distanceLegLeft&&this.b2Physics.world.DestroyJoint(Q.getPointer(this.parts.distanceLegLeft)),this.parts.distanceLegRight&&this.b2Physics.world.DestroyJoint(Q.getPointer(this.parts.distanceLegRight)),this.parts.weldCenter&&this.b2Physics.world.DestroyJoint(Q.getPointer(this.parts.weldCenter)),this.parts.prismatic&&this.b2Physics.world.DestroyJoint(Q.getPointer(this.parts.prismatic)),this.alreadyDetached=!0}jump(){if(this.scene.game.getFrame()-this.state.timeGrounded<6)return;const{isTailGrounded:e,isCenterGrounded:t,isNoseGrounded:s}=this.board;if(t||e||s){const e=t?l.Add(this.parts.body.GetWorldVector(new Q.b2Vec2(0,.3*this.jumpForce)),new Q.b2Vec2(0,1.25*this.jumpForce)):l.Add(this.parts.body.GetWorldVector(new Q.b2Vec2(0,.5*this.jumpForce)),new Q.b2Vec2(0,.85*this.jumpForce));this.parts.body.ApplyLinearImpulseToCenter(e,!0)}}resetLegs(){var e,t;null===(e=this.parts.distanceLegLeft)||void 0===e||e.SetLength(.65),null===(t=this.parts.distanceLegRight)||void 0===t||t.SetLength(.65)}leanBackward(){var e,t;null===(e=this.parts.distanceLegLeft)||void 0===e||e.SetLength(.5),null===(t=this.parts.distanceLegRight)||void 0===t||t.SetLength(.8),this.parts.body.ApplyAngularImpulse(this.leanForce,!0)}leanForward(){var e,t;null===(e=this.parts.distanceLegLeft)||void 0===e||e.SetLength(.8),null===(t=this.parts.distanceLegRight)||void 0===t||t.SetLength(.5),this.parts.body.ApplyAngularImpulse(-this.leanForce,!0)}leanCenter(){var e,t;null===(e=this.parts.distanceLegLeft)||void 0===e||e.SetLength(.5),null===(t=this.parts.distanceLegRight)||void 0===t||t.SetLength(.5)}leanUp(){var e,t;null===(e=this.parts.distanceLegLeft)||void 0===e||e.SetLength(.8),null===(t=this.parts.distanceLegRight)||void 0===t||t.SetLength(.8)}initBodyParts(){const e=this.b2Physics.rubeLoader.getBodiesByCustomProperty("string","phaserPlayerCharacterPart","armUpperLeft")[0],t=this.b2Physics.rubeLoader.getBodiesByCustomProperty("string","phaserPlayerCharacterPart","armLowerLeft")[0],s=this.b2Physics.rubeLoader.getBodiesByCustomProperty("string","phaserPlayerCharacterPart","armUpperRight")[0],i=this.b2Physics.rubeLoader.getBodiesByCustomProperty("string","phaserPlayerCharacterPart","armLowerRight")[0];this.parts={head:this.b2Physics.rubeLoader.getBodiesByCustomProperty("string","phaserPlayerCharacterPart","head")[0],body:this.b2Physics.rubeLoader.getBodiesByCustomProperty("string","phaserPlayerCharacterPart","body")[0],armUpperLeft:e,armLowerLeft:t,armUpperRight:s,armLowerRight:i,armUpperLeftRenderDepth:this.b2Physics.rubeLoader.bodyUserDataMap.get(e).depth,armLowerLeftRenderDepth:this.b2Physics.rubeLoader.bodyUserDataMap.get(t).depth,armUpperRightRenderDepth:this.b2Physics.rubeLoader.bodyUserDataMap.get(s).depth,armLowerRightRenderDepth:this.b2Physics.rubeLoader.bodyUserDataMap.get(i).depth,boardSegments:this.b2Physics.rubeLoader.getBodiesByCustomProperty("string","phaserPlayerCharacterPart","boardSegment"),bindingLeft:Q.castObject(this.b2Physics.rubeLoader.getJointsByCustomProperty("string","phaserPlayerCharacterSpring","bindingLeft")[0],Q.b2RevoluteJoint),bindingRight:Q.castObject(this.b2Physics.rubeLoader.getJointsByCustomProperty("string","phaserPlayerCharacterSpring","bindingRight")[0],Q.b2RevoluteJoint),distanceLegLeft:Q.castObject(this.b2Physics.rubeLoader.getJointsByCustomProperty("string","phaserPlayerCharacterSpring","distanceLegLeft")[0],Q.b2DistanceJoint),distanceLegRight:Q.castObject(this.b2Physics.rubeLoader.getJointsByCustomProperty("string","phaserPlayerCharacterSpring","distanceLegRight")[0],Q.b2DistanceJoint),weldCenter:Q.castObject(this.b2Physics.rubeLoader.getJointsByCustomProperty("string","phaserPlayerCharacterSpring","weldCenter")[0],Q.b2WeldJoint),prismatic:Q.castObject(this.b2Physics.rubeLoader.getJointsByCustomProperty("string","phaserPlayerCharacterSpring","prismatic")[0],Q.b2PrismaticJoint)}}}class C extends o.Scene{constructor(){super({key:"GameScene"})}setZoomLevel(){const e=this.cameras.main.zoom,t=this.playerController.state.getCurrentSpeed(),s=z,i=e+.02*((s-Math.min(Math.max(t/40,0),1)*(s-.5))*this.resolutionMod-e);this.cameras.main.setZoom(i)}setWindNoise(){const e=this.playerController.parts.head.GetLinearVelocity().Length();this.windNoise.setVolume(Math.min(Math.max(e/60*.3,.02),.5)),this.windNoise.setRate(Math.min(Math.max(e/60*1.5,.5),1.5))}create(){this.observer&&this.observer.destroy(),this.observer=new o.Events.EventEmitter,this.b2Physics=new p(this,40,{x:0,y:-10}),this.b2Physics.loadRubeScene(y()),this.b2Physics.loadRubeScene((()=>{const e=localStorage.getItem(N);return e&&U[e]?e:"character_santa"})()),this.playerController=new _(this,this.b2Physics),this.terrain=new h(this,this.b2Physics),this.resolutionMod=this.cameras.main.width/q,this.body=this.b2Physics.rubeLoader.getBodiesByCustomProperty("bool","phaserCameraFollow",!0)[0];const e=this.b2Physics.rubeLoader.bodyUserDataMap.get(this.body);this.cameras.main.startFollow(e,!1,.5,.5),this.cameras.main.setDeadzone(0,125),this.cameras.main.setBackgroundColor(3436742),this.cameras.main.setZoom(z*this.resolutionMod*1.5),this.cameras.main.scrollX-=this.cameras.main.width,this.cameras.main.scrollY-=this.cameras.main.height,this.snowboardSlide=this.sound.add("snowboard_slide_04",{loop:!0,volume:1,rate:1,delay:0,detune:1e3}),this.snowboardSlide.play(),this.windNoise=this.sound.add("wind",{loop:!0,volume:1,rate:1,delay:0,detune:0}),this.windNoise.play(),this.observer.on("surface_impact",((e,t,s,i,o)=>{const r=i?0:1200,a=this.snowboardSlide.detune,n=a+.7*(r-a);this.snowboardSlide.setDetune(n);const l=Math.min(e/12,1),h=Math.max(Math.min(l,1),.2);this.snowboardSlide.setVolume(h)})),this.observer.on("enter_in_air",(()=>{this.add.tween({targets:this.snowboardSlide,volume:.03,ease:"Linear",duration:250,onComplete:()=>this.snowboardSlide.setDetune(0)})})),this.scene.launch("GameUIScene",[this.observer,()=>{this.playerController.state.reset(),this.snowboardSlide.stop(),this.snowboardSlide.destroy(),this.windNoise.stop(),this.windNoise.destroy(),this.scene.restart(),Q.destroy(this.b2Physics.world)}]),this.observer.on("enter_crashed",(()=>this.cameras.main.shake(200,1/this.resolutionMod*.03)))}update(){this.b2Physics.update(),this.playerController.update(),this.setZoomLevel(),this.setWindNoise();const e=10*this.body.GetLinearVelocity().x;this.cameras.main.setFollowOffset(this.cameras.main.followOffset.x+.01*(-e-this.cameras.main.followOffset.x),0)}}var x=s(10),D=(s(21),s(237),s(773));const A="303158013990";var E=function(e,t,s,i){return new(s||(s=Promise))((function(o,r){function a(e){try{l(i.next(e))}catch(e){r(e)}}function n(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,n)}l((i=i.apply(e,t||[])).next())}))};const B=new class{constructor(){this.numAuthAttempts=0;{window.firebase=x.Z;const e={apiKey:"AIzaSyCCxWe4_fyEhV9Qyv3Sb1GF_AZchgbhBG8",authDomain:"snowboarding-game.firebaseapp.com",projectId:"snowboarding-game",storageBucket:"snowboarding-game.appspot.com",messagingSenderId:A,appId:"1:303158013990:web:d85e188299ea519e1936e7",measurementId:A};x.Z.initializeApp(e),this.auth=x.Z.auth(),this.auth.onAuthStateChanged((e=>E(this,void 0,void 0,(function*(){if(Z&&console.log("onAuthStateChanged user",e),e)e.displayName&&e.displayName!==localStorage.getItem(T)&&localStorage.setItem(T,e.displayName),this.setLevel(y());else{if(Z&&console.log("try signInAnonymously"),++this.numAuthAttempts>=3)throw new Error("failed to authenticate multiple times.");this.auth.signInAnonymously().catch((e=>console.error("Failed to login anonymous user",e)))}}))))}}setLevel(e){var t;this.numAuthAttempts=0,this.currentLevel=e,localStorage.setItem(F,e),(null===(t=this.auth)||void 0===t?void 0:t.currentUser)&&(this.rexLeaderboard=new D.wB({root:`leaderboard_${e}`,pageItemCount:200}))}submit(e){var t;return E(this,void 0,void 0,(function*(){if(e.id=f(),e.timestamp=Date.now(),this.saveScoreLocally(e),null===(t=this.auth)||void 0===t?void 0:t.currentUser){const t=yield this.rexLeaderboard.getScore(this.auth.currentUser.uid);if(!t||b(t)<b(e))return yield this.rexLeaderboard.post(b(e),e,e.timestamp),!0}return!1}))}saveScoreLocally(e){const t=JSON.parse(localStorage.getItem(R)||"{}"),s=t[e.level]||[];s.push(e),t[e.level]=s,localStorage.setItem(R,JSON.stringify(t))}},M="snowboarding_game_resolution",k="snowboarding_game_volume_music",I="snowboarding_game_volume_sfx",T="snowboarding_game_user_name",R="snowboarding_game_user_scores_v3",F="snowboarding_game_level_current",N="snowboarding_game_selected_character";var G;!function(e){e.level_001="level_001",e.level_002="level_002",e.level_003="level_003",e.level_004="level_004",e.level_005="level_005"}(G||(G={}));const O=[G.level_001,G.level_002,G.level_003,G.level_004],V={ContinueLife:"KevinMacLeod/Continue Life",Heartbreaking:"KevinMacLeod/Heartbreaking",RainsWillFall:"KevinMacLeod/Rains Will Fall",SadTrio:"KevinMacLeod/Sad Trio",StagesOfGrief:"KevinMacLeod/Stages of Grief"},U=["character_santa","character_santa_old"],j=100,J=5e3,K=200,W=.2,Y=8,q=1280,H=720,$=Number(localStorage.getItem(M)||1),z=Number(localStorage.getItem("snowboarding_game_debug_zoom")||1),Z=Boolean(localStorage.getItem("snowboarding_game_debug")),X={title:"Snowboarding Game",version:"1.1.1",type:o.AUTO,backgroundColor:"#ffffff",disableContextMenu:!0,parent:"phaser-wrapper",dom:{createContainer:!0},fps:{target:60,min:55,smoothStep:!0},scale:{mode:o.Scale.FIT,autoCenter:o.Scale.CENTER_BOTH,width:q*$,height:H*$},scene:[n,C,L],plugins:{global:[{key:"rexFirebase",plugin:r.Z,start:!0}]}};let Q;window.addEventListener("load",(()=>{(0,i.h4)().then((e=>{(0,a.Z)({locateFile:()=>e?"Box2D.simd.wasm":"Box2D.wasm"}).then((e=>{Q=e,new o.Game(X),navigator.onLine&&function(){const e=document.createElement("script");e.onload=function(){const e=new Stats;document.body.appendChild(e.dom),requestAnimationFrame((function t(){e.update(),requestAnimationFrame(t)}))},e.src="https://mrdoob.github.io/stats.js/build/stats.min.js",document.head.appendChild(e)}()}))}))}))}},o={};function r(e){var t=o[e];if(void 0!==t)return t.exports;var s=o[e]={exports:{}};return i[e].call(s.exports,s,s.exports,r),s.exports}r.m=i,e=[],r.O=(t,s,i,o)=>{if(!s){var a=1/0;for(c=0;c<e.length;c++){for(var[s,i,o]=e[c],n=!0,l=0;l<s.length;l++)(!1&o||a>=o)&&Object.keys(r.O).every((e=>r.O[e](s[l])))?s.splice(l--,1):(n=!1,o<a&&(a=o));if(n){e.splice(c--,1);var h=i();void 0!==h&&(t=h)}}return t}o=o||0;for(var c=e.length;c>0&&e[c-1][2]>o;c--)e[c]=e[c-1];e[c]=[s,i,o]},r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,s)=>(r.f[s](e,t),t)),[])),r.u=e=>e+"."+{325:"5c226c1b4e9d0b9aad7f",486:"17e73c9cf56d85afe071"}[e]+".chunk.js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},s="snowboarding-game:",r.l=(e,i,o,a)=>{if(t[e])t[e].push(i);else{var n,l;if(void 0!==o)for(var h=document.getElementsByTagName("script"),c=0;c<h.length;c++){var d=h[c];if(d.getAttribute("src")==e||d.getAttribute("data-webpack")==s+o){n=d;break}}n||(l=!0,(n=document.createElement("script")).charset="utf-8",n.timeout=120,r.nc&&n.setAttribute("nonce",r.nc),n.setAttribute("data-webpack",s+o),n.src=e),t[e]=[i];var u=(s,i)=>{n.onerror=n.onload=null,clearTimeout(p);var o=t[e];if(delete t[e],n.parentNode&&n.parentNode.removeChild(n),o&&o.forEach((e=>e(i))),s)return s(i)},p=setTimeout(u.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=u.bind(null,n.onerror),n.onload=u.bind(null,n.onload),l&&document.head.appendChild(n)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var i=s.length-1;i>-1&&!e;)e=s[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{r.b=document.baseURI||self.location.href;var e={179:0};r.f.j=(t,s)=>{var i=r.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var o=new Promise(((s,o)=>i=e[t]=[s,o]));s.push(i[2]=o);var a=r.p+r.u(t),n=new Error;r.l(a,(s=>{if(r.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var o=s&&("load"===s.type?"missing":s.type),a=s&&s.target&&s.target.src;n.message="Loading chunk "+t+" failed.\n("+o+": "+a+")",n.name="ChunkLoadError",n.type=o,n.request=a,i[1](n)}}),"chunk-"+t,t)}},r.O.j=t=>0===e[t];var t=(t,s)=>{var i,o,[a,n,l]=s,h=0;if(a.some((t=>0!==e[t]))){for(i in n)r.o(n,i)&&(r.m[i]=n[i]);if(l)var c=l(r)}for(t&&t(s);h<a.length;h++)o=a[h],r.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return r.O(c)},s=self.webpackChunksnowboarding_game=self.webpackChunksnowboarding_game||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var a=r.O(void 0,[216],(()=>r(866)));a=r.O(a)})();