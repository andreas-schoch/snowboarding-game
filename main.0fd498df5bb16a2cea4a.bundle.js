(()=>{"use strict";var e,t,s,i={384:(e,t,s)=>{s.d(t,{fl:()=>ge,T5:()=>Ce,k_:()=>Be,$D:()=>Ae,v3:()=>Se,eM:()=>Le,R$:()=>we,$7:()=>fe,m6:()=>Pe,qs:()=>be,gC:()=>he,Zu:()=>de,t9:()=>ue,$K:()=>le,uF:()=>ce,zq:()=>xe,rb:()=>pe,O2:()=>_e,mO:()=>me,nI:()=>ve,Iu:()=>se,Ro:()=>ie,yH:()=>te,X0:()=>ae,XG:()=>oe,N8:()=>re,c6:()=>ne,d5:()=>ye,b2:()=>Ie,Uc:()=>De,Fl:()=>ee,OZ:()=>Me}),s(168);var i=s(334),o=s(557),r=s(534);class n extends Phaser.Scene{constructor(){super({key:te})}preload(){this.loadAudio(),this.loadImg(),this.loadLevels(),this.load.html("dom_game_ui","assets/html/game_ui.html")}create(){this.scene.start(se)}loadAudio(){Object.values(Ce).forEach((e=>this.load.audio(e,`assets/audio/music/${e}.mp3`))),this.load.audio("boink","assets/audio/sfx/jump/boink.mp3"),this.load.audio("pickup_present","assets/audio/sfx/pickup/pickup_coins.wav"),this.load.audio("death","assets/audio/sfx/crash/death.mp3"),this.load.audio("grunt","assets/audio/sfx/crash_grunt/grunt.mp3"),this.load.audio("applause","assets/audio/sfx/applause/applause.mp3"),this.load.audio("game_over_demon","assets/audio/sfx/game_over_demon/game_over_demon.mp3"),this.load.audio("snowboard_slide_04","assets/audio/sfx/nox_sound/snowboard_slide_loop_04.mp3"),this.load.audio("wind","assets/audio/sfx/wind/wind-seamless-02.mp3")}loadImg(){const e=we*ve,t={360:"640x360",540:"960x540",720:"1280x720"}[[360,540,720].reduce(((t,s)=>Math.abs(s-e)<Math.abs(t-e)?s:t))];this.load.atlas("atlas_environment",`assets/img/packed/environment_${t}.png`,`assets/img/packed/environment_${t}.json`),this.load.atlas("bg_space_pack",`assets/img/packed/bg_space_${t}.png`,`assets/img/packed/bg_space_${t}.json`),Ae.forEach((e=>this.load.atlas(e,`assets/img/packed/${e}_${t}.png`,`assets/img/packed/${e}_${t}.json`)))}loadLevels(){xe.forEach((e=>this.load.json(e,`assets/levels/export/${e}.json`))),Be.forEach((e=>this.load.json(e,`assets/levels/export/${e}.json`)))}}class a{constructor(e){this.scene=e}draw(){const e=this.scene.b2Physics.loader.getBodiesByCustomProperty("surfaceType","snow");if(!e.length)return;const t=this.scene.b2Physics.worldScale;for(const s of e){const e=s.GetPosition();let i=new Ie.b2EdgeShape;for(let o=Me(s.GetFixtureList());Ie.getPointer(o)!==Ie.getPointer(Ie.NULL);o=Me(o.GetNext())){const s=Ie.castObject(o.GetShape(),Ie.b2ChainShape),r=[];for(let o=0;o<s.get_m_count()-1;o++){s.GetChildEdge(i,o);const n={x:(i.m_vertex1.x+e.x)*t,y:-(i.m_vertex1.y+e.y)*t},a={x:(i.m_vertex2.x+e.x)*t,y:-(i.m_vertex2.y+e.y)*t};r.push(n,a)}this.drawChunk(r)}}}drawChunk(e){const t=Math.min(...e.map((e=>e.x))),s=Math.min(...e.map((e=>e.y))),i=this.scene.add.graphics().setDepth(10);i.setPosition(t,s);const o=e.map((e=>({x:e.x-t,y:e.y-s})));i.fillStyle(Se?197123:11783922,1),i.fillPoints(o,!0,!1),o.shift(),o.shift(),o.shift(),o.pop(),o.pop(),o.pop(),i.lineStyle(2,0,1),i.strokePoints(o,!1,!1)}}const l=()=>Math.random().toString(36).slice(2);class c{static Clone(e){return new Ie.b2Vec2(e.x,e.y)}static Add(e,t){return e.x+=t.x,e.y+=t.y,e}static Rotate(e,t){const s=Math.cos(t),i=Math.sin(t),o=e.x;return e.x=s*o-i*e.y,e.y=i*o+s*e.y,e}static Scale(e,t,s){return e.x*=t,e.y*=s||t,e}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));return 0===t||e.Set(e.x/t,e.y/t),e}}class h{constructor(e){this.world=e,this.handleLoadImage=()=>null,this.userData=new Map,this.customProps=new Map,this.loadedScenes=new Map,this.loadingBodies=[],this.loadingJoints=[],this.loadingImages=[]}load(e,t=0,s=0){this.loadingBodies=e.body?e.body.map((e=>this.loadBody(e,t,s))):[],this.loadingJoints=e.joint?e.joint.map((e=>this.loadJoint(e))):[],this.loadingImages=e.image?e.image.map((e=>this.loadImage(e))):[];const i=this.loadingBodies.every((e=>e))&&this.loadingJoints.every((e=>e))&&this.loadingImages.every((e=>e));i?console.log("R.U.B.E. scene loaded successfully",this.loadingBodies,this.loadingJoints,this.loadingImages):console.error("R.U.B.E. scene failed to load fully",this.loadingBodies,this.loadingJoints,this.loadingImages);const o=l();return this.loadedScenes.set(o,{bodies:this.loadingBodies,joints:this.loadingJoints,images:this.loadingImages,id:o}),this.loadingBodies=[],this.loadingJoints=[],this.loadingImages=[],[i,o]}getBodiesByCustomProperty(e,t,s){const i=[];for(let o=Me(this.world.GetBodyList());Ie.getPointer(o)!==Ie.getPointer(Ie.NULL);o=Me(o.GetNext())){if(s&&!this.loadedScenes.get(s).bodies.includes(o))continue;const r=this.customProps.get(o);r&&r[e]===t&&i.push(o)}return i}getFixturesByCustomProperty(e,t,s){const i=[];for(let o=Me(this.world.GetBodyList());Ie.getPointer(o)!==Ie.getPointer(Ie.NULL);o=Me(o.GetNext()))if(!s||this.loadedScenes.get(s).bodies.includes(o))for(let s=Me(o.GetFixtureList());Ie.getPointer(s)!==Ie.getPointer(Ie.NULL);s=Me(s.GetNext())){const o=this.customProps.get(s);o&&o[e]===t&&i.push(s)}return i}getJointsByCustomProperty(e,t,s){const i=[];for(let o=Me(this.world.GetJointList());Ie.getPointer(o)!==Ie.getPointer(Ie.NULL);o=Me(o.GetNext())){if(s&&!this.loadedScenes.get(s).joints.includes(o))continue;const r=this.customProps.get(o);r&&r[e]===t&&i.push(o)}return i}rubeToVec2(e,t=0,s=0){const i=new Ie.b2Vec2(0,0);return this.isXY(e)&&i.Set(e.x+t,e.y+s),i}cleanup(){for(let e=Me(this.world.GetBodyList());Ie.getPointer(e)!==Ie.getPointer(Ie.NULL);e=Me(e.GetNext()))this.world.DestroyBody(e);for(let e=Me(this.world.GetJointList());Ie.getPointer(e)!==Ie.getPointer(Ie.NULL);e=Me(e.GetNext()))this.world.DestroyJoint(e)}loadBody(e,t,s){const i=new Ie.b2BodyDef;i.set_type(Math.min(Math.max(e.type||0,0),2)),i.set_angle(e.angle||0),i.set_angularVelocity(e.angularVelocity||0),i.set_awake(Boolean(e.awake)),i.set_enabled(!e.hasOwnProperty("active")||Boolean(e.active)),i.set_fixedRotation(Boolean(e.fixedRotation)),i.set_linearVelocity(this.rubeToVec2(e.linearVelocity)),i.set_linearDamping(e.linearDamping||0),i.set_angularDamping(e.angularDamping||0),i.set_position(this.rubeToVec2(e.position,t,s)),i.set_bullet(Boolean(e.bullet||!1));const o=new Ie.b2MassData;o.mass=e["massData-mass"]||1,o.center=this.rubeToVec2(e["massData-center"]),o.I=e["massData-I"]||1;const r=this.world.CreateBody(i);return r.SetMassData(o),Ie.destroy(o),Ie.destroy(i),this.userData.set(r,{name:e.name||"",image:null}),this.customProps.set(r,this.customPropertiesArrayToMap(e.customProperties||[])),(e.fixture||[]).forEach((e=>this.loadFixture(r,e))),r}loadFixture(e,t){const s=new Ie.b2Filter;s.set_categoryBits(t["filter-categoryBits"]||1),s.set_maskBits(t["filter-maskBits"]||65535),s.set_groupIndex(t["filter-groupIndex"]||0);const i=this.getFixtureDefWithShape(t);i.set_friction(t.friction||0),i.set_density(t.density||0),i.set_restitution(t.restitution||0),i.set_isSensor(Boolean(t.sensor)),i.set_filter(s);const o=e.CreateFixture(i);return Ie.destroy(i),Ie.destroy(s),this.customProps.set(o,this.customPropertiesArrayToMap(t.customProperties||[])),o}loadJoint(e){if(e.bodyA>=this.loadingBodies.length)return console.error("Index for bodyA is invalid: "+e),null;if(e.bodyB>=this.loadingBodies.length)return console.error("Index for bodyB is invalid: "+e),null;const t=this.loadingBodies[e.bodyA],s=this.loadingBodies[e.bodyB];if(!t||!s)return console.error("bodyA or bodyB are invalid",t,s,this.loadingBodies),null;let i;switch(e.type){case"revolute":{const o=new Ie.b2RevoluteJointDef;o.Initialize(t,s,c.Add(c.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition())),o.collideConnected=Boolean(e.collideConnected),o.referenceAngle=e.refAngle||0,o.enableLimit=Boolean(e.enableLimit),o.lowerAngle=e.lowerLimit||0,o.upperAngle=e.upperLimit||0,o.enableMotor=Boolean(e.enableMotor),o.maxMotorTorque=e.maxMotorTorque||0,o.motorSpeed=e.motorSpeed||0,i=this.world.CreateJoint(o),Ie.destroy(o);break}case"distance":{const o=new Ie.b2DistanceJointDef;o.length=e.length||0,o.Initialize(t,s,c.Add(c.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition()),c.Add(c.Rotate(this.rubeToVec2(e.anchorB),s.GetAngle()),s.GetPosition())),o.collideConnected=Boolean(e.collideConnected),o.length=e.length||0,o.minLength=0,o.maxLength=2*o.length,this.setLinearStiffness(o,e.frequency||0,e.dampingRatio||0,o.bodyA,o.bodyB),i=this.world.CreateJoint(o),Ie.destroy(o);break}case"prismatic":{const o=new Ie.b2PrismaticJointDef;o.Initialize(t,s,c.Add(c.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition()),this.rubeToVec2(e.localAxisA)),o.collideConnected=Boolean(e.collideConnected),o.referenceAngle=e.refAngle||0,o.enableLimit=Boolean(e.enableLimit),o.lowerTranslation=e.lowerLimit||0,o.upperTranslation=e.upperLimit||0,o.enableMotor=Boolean(e.enableMotor),o.maxMotorForce=e.maxMotorForce||0,o.motorSpeed=e.motorSpeed||0,i=this.world.CreateJoint(o),Ie.destroy(o);break}case"wheel":{const o=new Ie.b2WheelJointDef;o.Initialize(t,s,this.rubeToVec2(e.anchorB),this.rubeToVec2(e.localAxisA)),o.collideConnected=Boolean(e.collideConnected),o.enableMotor=Boolean(e.enableMotor),o.maxMotorTorque=e.maxMotorTorque||0,o.motorSpeed=e.motorSpeed||0,this.setLinearStiffness(o,e.springFrequency||0,e.springDampingRatio||0,o.bodyA,o.bodyB),i=this.world.CreateJoint(o),Ie.destroy(o);break}case"friction":{const o=new Ie.b2FrictionJointDef;o.Initialize(t,s,c.Add(c.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition())),o.collideConnected=Boolean(e.collideConnected),o.maxForce=e.maxForce||0,o.maxTorque=e.maxTorque||0,i=this.world.CreateJoint(o),Ie.destroy(o);break}case"weld":{const o=new Ie.b2WeldJointDef;o.Initialize(t,s,c.Add(c.Rotate(this.rubeToVec2(e.anchorA),t.GetAngle()),t.GetPosition())),o.collideConnected=Boolean(e.collideConnected),o.referenceAngle=e.refAngle||0,this.setAngularStiffness(o,e.frequency||0,e.dampingRatio||0,o.bodyA,o.bodyB),i=this.world.CreateJoint(o),Ie.destroy(o);break}default:throw new Error("Unsupported joint type: "+e.type)}return this.customProps.set(i,this.customPropertiesArrayToMap(e.customProperties||[])),i}setLinearStiffness(e,t,s,i,o){const r=Ie._malloc(2*Float32Array.BYTES_PER_ELEMENT);Ie.b2LinearStiffness(r,r+Float32Array.BYTES_PER_ELEMENT,t||0,s||0,i,o);const[n,a]=Ie.HEAPF32.subarray(r>>2);Ie._free(r),e.stiffness=n,e.damping=a}setAngularStiffness(e,t,s,i,o){const r=Ie._malloc(2*Float32Array.BYTES_PER_ELEMENT);Ie.b2AngularStiffness(r,r+Float32Array.BYTES_PER_ELEMENT,t||0,s||0,i,o);const[n,a]=Ie.HEAPF32.subarray(r>>2);Ie._free(r),e.stiffness=n,e.damping=a}loadImage(e){const{body:t,customProperties:s}=e,i=this.loadingBodies[t],o=this.customPropertiesArrayToMap(s||[]),r=this.handleLoadImage(e,i,o);if(!r)return null;const n=this.customPropertiesArrayToMap(s||[]);if(this.customProps.set(r,n),i){const e=this.userData.get(i);if(!e)throw new Error("bodyUserDataMap is missing bodyObj. this should never happen");e.image=r}return r}customPropertiesArrayToMap(e){return e.reduce(((e,t)=>{if(t.hasOwnProperty("int"))e[t.name]=t.int;else if(t.hasOwnProperty("float"))e[t.name]=t.float;else if(t.hasOwnProperty("string"))e[t.name]=t.string;else if(t.hasOwnProperty("color"))e[t.name]=t.color;else if(t.hasOwnProperty("bool"))e[t.name]=t.bool;else{if(!t.hasOwnProperty("vec2"))throw new Error("invalid or missing custom property type");e[t.name]=this.rubeToVec2(t.vec2)}return e}),{})}getFixtureDefWithShape(e){const t=new Ie.b2FixtureDef;if(e.hasOwnProperty("circle")&&e.circle)t.shape=this.createCircleShape(e.circle);else if(e.hasOwnProperty("polygon")&&e.polygon)t.shape=this.createPolygonShape(e.polygon);else{if(!e.hasOwnProperty("chain")||!e.chain)throw new Error("Could not find shape type for fixture");t.shape=this.createChainShape(e.chain)}return t}createCircleShape(e){if(!e)throw new Error("fixtureJson.circle is missing");const t=new Ie.b2CircleShape;return t.set_m_radius(e.radius),t.set_m_p(this.rubeToVec2(e.center)),t}createPolygonShape(e){if(!e)throw new Error("fixtureJson.polygon is missing");const t=this.pointsFromSeparatedVertices(e.vertices).reverse(),{_malloc:s,b2Vec2:i,b2PolygonShape:o,HEAPF32:r,wrapPointer:n}=Ie,a=new o,l=s(8*t.length);let c=0;for(let e=0;e<t.length;e++)r[l+c>>2]=t[e].get_x(),r[l+(c+4)>>2]=t[e].get_y(),c+=8;const h=n(l,i);return a.Set(h,t.length),a}createChainShape(e){if(!e)throw new Error("fixtureJson.chain is missing");const t=this.pointsFromSeparatedVertices(e.vertices).reverse(),s=Boolean(e.hasNextVertex&&e.hasPrevVertex&&e.nextVertex&&e.prevVertex),{_malloc:i,b2Vec2:o,b2ChainShape:r,HEAPF32:n,wrapPointer:a}=Ie,l=new r,c=i(8*t.length);let h=0;for(let e=0;e<t.length;e++)n[c+h>>2]=t[e].get_x(),n[c+(h+4)>>2]=t[e].get_y(),h+=8;const d=a(c,o);return s?l.CreateLoop(d,t.length):l.CreateChain(d,t.length,this.rubeToVec2(e.prevVertex),this.rubeToVec2(e.nextVertex)),l}pointsFromSeparatedVertices(e){const t=[];for(let s=0;s<e.x.length;s++)t.push(new Ie.b2Vec2(e.x[s],e.y[s]));return t}isXY(e){return Boolean(e&&"object"==typeof e&&e.hasOwnProperty("x")&&e.hasOwnProperty("y"))}}const d=2*Float32Array.BYTES_PER_ELEMENT;class u{constructor(e,t,s=2){this.graphics=e,this.pixelsPerMeter=t,this.lineWidth=s,this.instance=new Ie.JSDraw,this.instance.AppendFlags(Ie.b2Draw.e_shapeBit),this.instance.AppendFlags(Ie.b2Draw.e_jointBit),this.instance.DrawSegment=(e,t,s)=>{const i=Ie.wrapPointer(e,Ie.b2Vec2),o=Ie.wrapPointer(t,Ie.b2Vec2),r=Ie.wrapPointer(s,Ie.b2Color),n=(new Phaser.Display.Color).setGLTo(r.r,r.g,r.b,1);this.graphics.lineStyle(this.lineWidth,n.color,1),this.graphics.lineBetween(i.x*this.pixelsPerMeter,-i.y*this.pixelsPerMeter,o.x*this.pixelsPerMeter,-o.y*this.pixelsPerMeter)},this.instance.DrawPolygon=(e,t,s)=>{const i=Ie.wrapPointer(s,Ie.b2Color),o=[];for(let s=0;s<t;s++)o.push(Ie.wrapPointer(e+s*d,Ie.b2Vec2));const r=(new Phaser.Display.Color).setGLTo(i.r,i.g,i.b,1);this.graphics.lineStyle(this.lineWidth,r.color,1),this.graphics.strokePoints(o.map((e=>new Phaser.Math.Vector2(e.x*this.pixelsPerMeter,-e.y*this.pixelsPerMeter))),!0,!0)},this.instance.DrawCircle=(e,t,s)=>{const i=Ie.wrapPointer(e,Ie.b2Vec2),o=Ie.wrapPointer(s,Ie.b2Color),r=(new Phaser.Display.Color).setGLTo(o.r,o.g,o.b,1);this.graphics.lineStyle(this.lineWidth,r.color,1),this.graphics.strokeCircle(i.x*this.pixelsPerMeter,-i.y*this.pixelsPerMeter,t*this.pixelsPerMeter)},this.instance.DrawPoint=(e,t,s)=>{const i=Ie.wrapPointer(e,Ie.b2Vec2),o=Ie.wrapPointer(s,Ie.b2Color),r=(new Phaser.Display.Color).setGLTo(o.r,o.g,o.b,1);this.graphics.lineStyle(this.lineWidth,r.color,1),this.graphics.strokeCircle(i.x*this.pixelsPerMeter,-i.y*this.pixelsPerMeter,t)},this.instance.DrawSolidPolygon=(e,t,s)=>this.instance.DrawPolygon(e,t,s),this.instance.DrawSolidCircle=(e,t,s,i)=>this.instance.DrawCircle(e,t,i),this.instance.DrawTransform=e=>{}}clear(){setTimeout((()=>this.graphics.clear()),0)}}const m={1:"revolute",2:"prismatic",3:"distance",7:"wheel",8:"weld",9:"friction",10:"rope",11:"motor"};class p{constructor(e,t){this.world=e,this.loader=t,this.handleSerializeImage=()=>{throw new Error("Image serialization not implemented")},this.indexByBody=new Map}serialize(){const e={gravity:this.serializeVector(this.world.GetGravity()),allowSleep:this.world.GetAllowSleeping(),autoClearForces:this.world.GetAutoClearForces(),positionIterations:10,velocityIterations:10,stepsPerSecond:60,warmStarting:this.world.GetWarmStarting(),continuousPhysics:this.world.GetContinuousPhysics(),subStepping:this.world.GetSubStepping(),customProperties:[],body:this.serializeBodies(),joint:this.serializeJoints(),image:this.serializeImages()},t=JSON.stringify(e),s=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(s),o=document.createElement("a");return o.href=i,o.download="rube scene test.json",o.click(),URL.revokeObjectURL(i),e}serializeBodies(){const e=[];for(let t=Me(this.world.GetBodyList());Ie.getPointer(t)!==Ie.getPointer(Ie.NULL);t=Me(t.GetNext()))this.indexByBody.set(t,e.length),e.push(this.serializeBody(t));return e}serializeBody(e){return{name:"body name irrelevant for now",active:e.IsEnabled(),awake:e.IsAwake(),bullet:e.IsBullet(),fixedRotation:e.IsFixedRotation(),type:e.GetType(),position:this.serializeVector(e.GetPosition()),angle:e.GetAngle(),angularDamping:e.GetAngularDamping(),angularVelocity:e.GetAngularVelocity(),linearDamping:e.GetLinearDamping(),linearVelocity:this.serializeVector(e.GetLinearVelocity()),"massData-mass":e.GetMass(),"massData-center":this.serializeVector(e.GetLocalCenter()),"massData-I":e.GetInertia(),customProperties:this.serializeCustomProperties(e),fixture:this.serializeFixtures(e)}}serializeCustomProperties(e){const t=this.loader.customProps.get(e);if(!t)return;const s=[];for(const[e,i]of Object.entries(t))if("number"==typeof i&&Number.isInteger(i))s.push({name:e,int:i});else if("number"==typeof i)s.push({name:e,float:i});else if("string"==typeof i)s.push({name:e,string:i});else if("boolean"==typeof i)s.push({name:e,bool:i});else{if(!(i instanceof Ie.b2Vec2))throw new Error("Custom property type not supported");s.push({name:e,vec2:this.serializeVector(i)})}return s}serializeFixtures(e){const t=[];for(let s=Me(e.GetFixtureList());Ie.getPointer(s)!==Ie.getPointer(Ie.NULL);s=Me(s.GetNext()))t.push(this.serializeFixture(s));return t}serializeFixture(e){const{categoryBits:t,maskBits:s,groupIndex:i}=e.GetFilterData(),o=e.GetShape(),r=o.GetType(),n={name:"fixture name irrelevant for now",density:e.GetDensity(),"filter-categoryBits":t,"filter-maskBits":s,"filter-groupIndex":i,friction:e.GetFriction(),restitution:e.GetRestitution(),sensor:e.IsSensor(),customProperties:this.serializeCustomProperties(e)};return r===Ie.b2Shape.e_circle&&(n.circle=this.serializeCircleShape(o)),r===Ie.b2Shape.e_polygon&&(n.polygon=this.serializePolygonShape(o)),r===Ie.b2Shape.e_chain&&(n.chain=this.serializeChainShape(o)),n}serializeCircleShape(e){const t=Ie.castObject(e,Ie.b2CircleShape);return{center:this.serializeVector(t.get_m_p()),radius:e.get_m_radius()}}serializePolygonShape(e){const t=Ie.castObject(e,Ie.b2PolygonShape),s=Ie.reifyArray(Ie.getPointer(t.m_vertices),t.m_count,8,Ie.b2Vec2),i={x:[],y:[]};for(const{x:e,y:t}of s)i.x.push(e),i.y.push(t);return{vertices:i}}serializeChainShape(e){const t=Ie.castObject(e,Ie.b2ChainShape),s=Ie.reifyArray(Ie.getPointer(t.m_vertices),t.m_count,8,Ie.b2Vec2),i={x:[],y:[]};for(const{x:e,y:t}of s.reverse())i.x.push(e),i.y.push(t);return{vertices:i,hasNextVertex:Boolean(t.m_nextVertex),hasPrevVertex:Boolean(t.m_prevVertex),nextVertex:this.serializeVector(t.m_nextVertex),prevVertex:this.serializeVector(t.m_prevVertex)}}serializeJoints(){if(0!==this.world.GetJointCount()&&0===this.indexByBody.size)throw new Error("Joints cannot be serialized before bodies");const e=[];for(let t=Me(this.world.GetJointList());Ie.getPointer(t)!==Ie.getPointer(Ie.NULL);t=Me(t.GetNext()))e.push(this.serializeJoint(t));return e}serializeJoint(e){const t=e.GetType(),s=m[t];if(void 0===s)throw new Error(`Unknown joint type: ${t}`);switch(s){case"revolute":return this.serializeRevoluteJoint(e);case"prismatic":return this.serializePrismaticJoint(e);case"distance":return this.serializeDistanceJoint(e);case"wheel":return this.serializeWheelJoint(e);case"weld":return this.serializeWeldJoint(e);case"friction":return this.serializeFrictionJoint(e);case"rope":throw new Error("Rope joint serialization not implemented");case"motor":return this.serializeMotorJoint(e)}}serializeJointBase(e){const t=e.GetBodyA(),s=e.GetBodyB(),i=this.indexByBody.get(t),o=this.indexByBody.get(s),r=e.GetAnchorA(),n=e.GetAnchorB(),a=c.Rotate(new Ie.b2Vec2(r.x-t.GetPosition().x,r.y-t.GetPosition().y),-t.GetAngle()),l=c.Rotate(new Ie.b2Vec2(n.x-s.GetPosition().x,n.y-s.GetPosition().y),-s.GetAngle());if(void 0===i||void 0===o)throw new Error("Joint body index not found");return{type:m[e.GetType()],name:"joint name irrelevant for now",anchorA:this.serializeVector(a),anchorB:this.serializeVector(l),bodyA:i,bodyB:o,collideConnected:e.GetCollideConnected(),customProperties:this.serializeCustomProperties(e)}}serializeRevoluteJoint(e){const t=Ie.castObject(e,Ie.b2RevoluteJoint);return Object.assign(Object.assign({},this.serializeJointBase(e)),{type:"revolute",enableLimit:t.IsLimitEnabled(),lowerLimit:t.GetLowerLimit(),upperLimit:t.GetUpperLimit(),enableMotor:t.IsMotorEnabled(),motorSpeed:t.GetMotorSpeed(),maxMotorTorque:t.GetMaxMotorTorque(),refAngle:t.GetReferenceAngle()})}serializePrismaticJoint(e){const t=Ie.castObject(e,Ie.b2PrismaticJoint);return Object.assign(Object.assign({},this.serializeJointBase(e)),{type:"prismatic",enableLimit:t.IsLimitEnabled(),enableMotor:t.IsMotorEnabled(),localAxisA:this.serializeVector(t.GetLocalAxisA()),lowerLimit:t.GetLowerLimit(),maxMotorForce:t.GetMaxMotorForce(),motorSpeed:t.GetMotorSpeed(),upperLimit:t.GetUpperLimit(),refAngle:t.GetReferenceAngle()})}serializeDistanceJoint(e){const t=Ie.castObject(e,Ie.b2DistanceJoint),{frequencyHertz:s,dampingRatio:i}=this.getJointFrequencyAndDampingRatio(t);return Object.assign(Object.assign({},this.serializeJointBase(e)),{type:"distance",dampingRatio:i,frequency:s,length:t.GetLength()})}serializeWheelJoint(e){const t=Ie.castObject(e,Ie.b2WheelJoint),{frequencyHertz:s,dampingRatio:i}=this.getJointFrequencyAndDampingRatio(t);return Object.assign(Object.assign({},this.serializeJointBase(e)),{type:"wheel",springDampingRatio:i,springFrequency:s,localAxisA:this.serializeVector(t.GetLocalAxisA()),enableMotor:t.IsMotorEnabled(),maxMotorTorque:t.GetMaxMotorTorque(),motorSpeed:t.GetMotorSpeed()})}serializeWeldJoint(e){const t=Ie.castObject(e,Ie.b2WeldJoint),{frequencyHertz:s,dampingRatio:i}=this.getJointFrequencyAndDampingRatio(t);return Object.assign(Object.assign({},this.serializeJointBase(e)),{type:"weld",refAngle:t.GetReferenceAngle(),dampingRatio:i,frequency:s})}serializeFrictionJoint(e){const t=Ie.castObject(e,Ie.b2FrictionJoint);return Object.assign(Object.assign({},this.serializeJointBase(e)),{type:"friction",maxForce:t.GetMaxForce(),maxTorque:t.GetMaxTorque()})}serializeMotorJoint(e){const t=Ie.castObject(e,Ie.b2MotorJoint);return Object.assign(Object.assign({},this.serializeJointBase(e)),{type:"motor",maxForce:t.GetMaxForce(),maxTorque:t.GetMaxTorque(),correctionFactor:t.GetCorrectionFactor()})}serializeImages(){const e=[];for(const t of[]){if(!t)throw new Error("Image not loaded");const s=this.handleSerializeImage(t);e.push(s)}return e}serializeVector(e){return 0===e.x&&0===e.y?0:{x:e.x,y:e.y}}getJointFrequencyAndDampingRatio(e){const t=e.GetStiffness(),s=e.GetDamping(),i=e.GetBodyA().GetMass()+e.GetBodyB().GetMass(),o=Math.sqrt(t/i);return{frequencyHertz:o/(2*Math.PI),dampingRatio:s/(2*i*o)}}}const g="score_change",y="combo_change",b="pickup_present",f="combo_leeway_update",w="level_finish",v="enter_grounded",P="enter_crashed",S="enter_in_air",L="b2_begin_contact",_="b2_post_solve",x="surface_impact",C="speed_change",B="toggle_pause",A="pause_game_icon_pressed",E="how_to_play_icon_pressed",I="resume_game",D="restart_game";class M extends Phaser.Events.EventEmitter{constructor(e,t){super(),this.scene=e,this.config=t,this.isPaused=!1,this.stepDeltaTime=1/60,this.stepConfig={positionIterations:12,velocityIterations:12},this.worldScale=t.worldScale,this.debugDrawer=new u(this.scene.add.graphics().setDepth(5e3),this.config.worldScale),this.world=this.initWorld(),this.loader=this.initLoader(),this.serializer=this.initSerializer(),this.initContactListeners()}load(e,t=0,s=0){const i=this.scene.cache.json.get(e),[o,r]=this.loader.load(i,t,s);if(!o)throw new Error("Failed to load RUBE scene");return r}update(){if(this.isPaused)return;this.world.Step(this.stepDeltaTime,this.stepConfig.positionIterations,this.stepConfig.positionIterations);const e=this.worldScale;for(let t=Me(this.world.GetBodyList());Ie.getPointer(t)!==Ie.getPointer(Ie.NULL);t=Me(t.GetNext())){if(!t)continue;const s=this.loader.userData.get(t),i=null==s?void 0:s.image;if(i)if(t.IsEnabled()){let s=t.GetPosition();i.setVisible(!0),i.x=s.x*e,i.y=-s.y*e,i.rotation=-t.GetAngle()+(i.data.get("angle_offset")||0)}else i.visible=!1}}initWorld(){const e=new Ie.b2Vec2(this.config.gravityX,this.config.gravityY),t=new Ie.b2World(e);return t.SetAutoClearForces(!0),t.SetDebugDraw(this.debugDrawer.instance),Ie.destroy(e),t}initLoader(){const e=new h(this.world);return e.handleLoadImage=(e,t,s)=>{const{file:i,center:o,angle:r,aspectScale:n,scale:a,flip:l,renderOrder:c}=e,h=t?t.GetPosition():this.loader.rubeToVec2(o),d=t?this.loader.customProps.get(t):null,u=Boolean(null==d?void 0:d.phaserPlayerCharacterPart);if(!h)return null;const m=(i||"").split("/").reverse()[0],p=u?(()=>{const e=localStorage.getItem(ue);return e&&Ae[e]?e:"character_v02_santa"})():s.phaserTexture,g=this.scene.add.image(h.x*this.worldScale,h.y*-this.worldScale,p||m,m);if(g.rotation=t?-t.GetAngle()-(r||0):-(r||0),g.scaleY=this.worldScale/g.height*a,g.scaleX=g.scaleY*n,g.alpha=e.opacity||1,g.flipX=l,g.setDepth(c),g.setDataEnabled(),Se){const e=!0===(null==d?void 0:d.light)||"present_temp.png"===m;u?g.setTintFill(0):e?g.setTintFill(12303291):g.setTintFill(2236962)}return g.data.set("image-json",e),g.data.set("angle_offset",-(r||0)),g},e}initSerializer(){const e=new p(this.world,this.loader);return e.handleSerializeImage=e=>e.data.get("image-json"),e}initContactListeners(){const e=new Ie.JSContactListener;e.BeginContact=e=>{const t=Ie.wrapPointer(e,Ie.b2Contact),s=t.GetFixtureA(),i=t.GetFixtureB(),o=s.GetBody(),r=i.GetBody(),n={contact:t,fixtureA:s,fixtureB:i,bodyA:o,bodyB:r};this.emit(L,n)},e.EndContact=()=>null,e.PreSolve=()=>null,e.PostSolve=(e,t)=>{const s=Ie.wrapPointer(e,Ie.b2Contact),i=Ie.wrapPointer(t,Ie.b2ContactImpulse),o=s.GetFixtureA(),r=s.GetFixtureB(),n=o.GetBody(),a=r.GetBody(),l={contact:s,impulse:i,fixtureA:o,fixtureB:r,bodyA:n,bodyB:a};this.emit(_,l)},this.world.SetContactListener(e)}}const k=(e,t=!0)=>e.distance+F(e,t)+e.coins*me+(e.finishedLevel?pe:0),F=(e,t)=>t?e.trickScore:e.trickScoreLog.reduce(((e,t)=>"combo"===t.type?e+t.multiplier*t.accumulator:"flip"===t.type?e+t.flips*t.flips*ge:e),0),R=()=>{const e=localStorage.getItem(he);return e&&xe.includes(e)?e:_e.level_001},T=[{id:"level_001",name:"Santas Backyard",thumbnail:"assets/img/thumbnails/level_001_santas_backyard.png",number:1,tags:["snow","christmas","winter","easy","beginner"],created:1e7,modified:1e7},{id:"level_002",name:"The Rollercoaster",thumbnail:"assets/img/thumbnails/level_002_the_rollercoaster.png",number:2,tags:["snow","christmas","winter","easy","beginner"],created:1e7,modified:1e7},{id:"level_003",name:"Building Bridges",thumbnail:"assets/img/thumbnails/level_003_building_bridges.png",number:3,tags:["snow","christmas","winter","easy","beginner"],created:1e7,modified:1e7},{id:"level_004",name:"Rocky Roads",thumbnail:"assets/img/thumbnails/level_004_rocky_roads.png",number:4,tags:["snow","christmas","winter","easy","beginner"],created:1e7,modified:1e7},{id:"level_005",name:"The other Way",thumbnail:"assets/img/thumbnails/level_005_looking_the_other_way.png",number:5,tags:["snow","christmas","winter","easy","beginner"],created:1e7,modified:1e7}];class G{}var O,N,V=function(e,t,s,i){return new(s||(s=Promise))((function(o,r){function n(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,a)}l((i=i.apply(e,t||[])).next())}))};!function(e){e.PANEL_PAUSE_MENU="panel-pause-menu",e.PANEL_SELECT_LEVEL="panel-select-level",e.PANEL_LEADERBOARDS="panel-leaderboards",e.PANEL_HOW_TO_PLAY="panel-how-to-play",e.PANEL_SETTINGS="panel-settings",e.PANEL_CREDITS="panel-credits",e.PANEL_YOUR_SCORE="panel-your-score",e.NONE="none"}(O||(O={})),function(e){e.HUD_DISTANCE="hud-distance",e.HUD_COMBO="hud-combo",e.HUD_SCORE="hud-score"}(N||(N={}));class j extends Phaser.Scene{constructor(){super({key:ie}),this.panels=[],this.pendingScore=null,this.localScores=[],this.crashed=!1,this.finished=!1}init([e]){this.observer=e,this.resolutionMod=this.game.canvas.width/fe}create(){const e=this.cameras.main.worldView.x+this.cameras.main.width/2;this.cameras.main.worldView.y,this.cameras.main.height,ee.setLevel(R()),this.initDomUi(),this.observer.on(B,((e,t)=>this.setPanelVisibility(e?t:O.NONE))),this.observer.on(b,(e=>{this.hudDistance&&(this.hudDistance.innerText=String(e)+"x")})),this.observer.on(y,((e,t)=>{this.hudCombo&&(this.hudCombo.innerText=e?e+"x"+t:"-")})),this.observer.on(g,(e=>{this.hudScore&&(this.hudScore.innerText=String(k(e)))})),this.comboLeewayChart=this.add.graphics(),this.observer.on(f,(t=>{this.comboLeewayChart.clear().fillStyle(16777215).slice(e,72*this.resolutionMod,12*this.resolutionMod,t,1.5*Math.PI).fillPath()})),this.observer.on(P,((e,t)=>{t===G.possessedCharacterId&&(this.pendingScore=e,this.crashed=!0,this.finished||(this.hudCombo&&(this.hudCombo.innerText="-"),this.comboLeewayChart.clear(),setTimeout((()=>V(this,void 0,void 0,(function*(){yield this.updateYourScorePanelData(e),this.setPanelVisibility(O.PANEL_YOUR_SCORE)}))),750)))})),this.observer.on(w,(e=>{this.crashed||(this.pendingScore=e,this.finished=!0,this.comboLeewayChart.clear(),setTimeout((()=>V(this,void 0,void 0,(function*(){yield this.updateYourScorePanelData(e),this.setPanelVisibility(O.PANEL_YOUR_SCORE)}))),2e3))}))}update(){}initDomUi(){const e=document.querySelector("#phaser-ui-wrapper");if(!e)throw new Error("uiWrapper not found");e.innerHTML="";let t=document.querySelector("#game-ui");if(e.insertAdjacentHTML("beforeend",this.cache.html.get("dom_game_ui")),t=document.querySelector("#game-ui"),!t)throw new Error("element not found");document.body.classList.add(Se?"darkmode":"lightmode");const s=localStorage.getItem(oe)||"1",i=Array.from(document.querySelectorAll('#settings-form input[name="resolution"]'));for(const e of i)e.value===s&&(e.checked=!0);const o=localStorage.getItem(re)||"80",r=document.querySelector('#settings-form input[name="volumeMusic"]');r&&(r.value=o);const n=localStorage.getItem(ne)||"80",a=document.querySelector('#settings-form input[name="volumeSfx"]');a&&(a.value=n);const l=document.querySelector('#settings-form input[name="darkmodeEnabled"]');l&&(l.checked=Se);const c=this.sys.game.device.browser;if(!(c.chrome||c.edge||c.opera||c.firefox)){const e=document.getElementById("unsupported-browser-notice");if(!e)throw new Error('element with id "unsupported-browser-notice" not found');console.warn("Unsupported browser detected. Game may run well but it was not optimized for this particular browser:",c),e.classList.remove("hidden")}const h=document.getElementById("pause-game-icon"),d=document.getElementById("how-to-play-icon");if(h&&d&&setTimeout((()=>{h.classList.remove("hidden"),d.classList.remove("hidden")}),250),this.panelPauseMenu=document.getElementById(O.PANEL_PAUSE_MENU),this.panelSelectLevel=document.getElementById(O.PANEL_SELECT_LEVEL),this.panelHowToPlay=document.getElementById(O.PANEL_HOW_TO_PLAY),this.panelLeaderboards=document.getElementById(O.PANEL_LEADERBOARDS),this.panelSettings=document.getElementById(O.PANEL_SETTINGS),this.panelCredits=document.getElementById(O.PANEL_CREDITS),this.panelYourScore=document.getElementById(O.PANEL_YOUR_SCORE),this.hudDistance=document.getElementById(N.HUD_DISTANCE),this.hudCombo=document.getElementById(N.HUD_COMBO),this.hudScore=document.getElementById(N.HUD_SCORE),!this.panelPauseMenu)throw new Error("panelPauseMenu not found");if(!this.panelSelectLevel)throw new Error("panelSelectLevel not found");if(!this.panelHowToPlay)throw new Error("panelHowToPlay not found");if(!this.panelLeaderboards)throw new Error("panelLeaderboards not found");if(!this.panelSettings)throw new Error("panelSettings not found");if(!this.panelCredits)throw new Error("panelCredits not found");if(!this.panelYourScore)throw new Error("panelYourScore not found");if(!this.hudDistance)throw new Error("hudDistance not found");if(!this.hudCombo)throw new Error("hudCombo not found");if(!this.hudScore)throw new Error("hudScore not found");return this.panels=[this.panelPauseMenu,this.panelSelectLevel,this.panelHowToPlay,this.panelLeaderboards,this.panelSettings,this.panelCredits,this.panelYourScore],t.onclick=e=>V(this,void 0,void 0,(function*(){var t,s,i,o;const r=e.target;if(r)switch(r.id){case"btn-goto-pause-menu":this.setPanelVisibility(O.PANEL_PAUSE_MENU);break;case"btn-resume-game":this.setPanelVisibility(O.NONE),this.observer.emit(I);break;case"btn-goto-select-level":{const e=document.querySelector("#panel-select-level #btn-goto-pause-menu");e&&(this.crashed?e.classList.add("hidden"):e.classList.remove("hidden")),yield this.updateLevelItems(),this.setPanelVisibility(O.PANEL_SELECT_LEVEL);break}case"btn-goto-how-to-play":this.setPanelVisibility(O.PANEL_HOW_TO_PLAY);break;case"btn-goto-leaderboards":yield this.updateLeaderboardPanelData(),this.setPanelVisibility(O.PANEL_LEADERBOARDS);break;case"btn-goto-settings":this.setPanelVisibility(O.PANEL_SETTINGS);break;case"btn-goto-credits":this.setPanelVisibility(O.PANEL_CREDITS);break;case"pause-game-icon":(null===(t=this.panelPauseMenu)||void 0===t?void 0:t.classList.contains("hidden"))&&this.observer.emit(A);break;case"how-to-play-icon":(null===(s=this.panelPauseMenu)||void 0===s?void 0:s.classList.contains("hidden"))&&this.observer.emit(E);break;case"btn-score-submit":{const e=document.querySelector(".submit-score"),t=document.getElementById("username");(null==t?void 0:t.value)&&this.pendingScore&&e&&((null===(i=ee.auth)||void 0===i?void 0:i.currentUser)&&(ee.rexLeaderboard.setUser({userID:ee.auth.currentUser.uid,userName:t.value}),yield ee.auth.currentUser.updateProfile({displayName:t.value})),localStorage.setItem(le,t.value),yield ee.submit(this.pendingScore),yield this.updateYourScorePanelData(this.pendingScore),e.classList.add("hidden"));break}case"btn-save-settings":{e.preventDefault();const t=null===(o=this.panelSettings)||void 0===o?void 0:o.querySelector("form");t&&(localStorage.setItem(oe,t.resolution.value||"1"),localStorage.setItem(re,t.volumeMusic.value),localStorage.setItem(ne,t.volumeSfx.value),localStorage.setItem(ae,t.darkmodeEnabled.checked),location.reload());break}case"btn-play-again":this.setPanelVisibility(O.NONE),this.playAgain();break;case"level_001":case"level_002":case"level_003":case"level_004":case"level_005":localStorage.setItem(he,r.id),ee.setLevel(r.id),this.setPanelVisibility(O.NONE),this.playAgain();break;default:Le&&console.log("non-interactable target id",r.id)}})),t}playAgain(){this.crashed=!1,this.finished=!1,this.observer.emit(D)}setPanelVisibility(e){const t=document.getElementById("pause-game-icon"),s=document.getElementById("how-to-play-icon");t&&s&&(e===O.NONE?(t.classList.remove("hidden"),s.classList.remove("hidden")):(t.classList.add("hidden"),s.classList.add("hidden"))),this.panels.forEach((t=>{t.id===e?t.classList.remove("hidden"):t.classList.add("hidden")}))}updateYourScorePanelData(e){var t;return V(this,void 0,void 0,(function*(){if(this.panelYourScore){const s=document.getElementById("your-score-distance"),i=document.getElementById("your-score-coins"),o=document.getElementById("your-score-trick-score"),r=document.getElementById("your-score-bonus"),n=document.getElementById("your-score-best-combo"),a=document.getElementById("your-score-total"),c=document.getElementById("username"),h=document.querySelector(".submit-score");e.finishedLevel?this.panelYourScore.classList.add("succeeded"):this.panelYourScore.classList.remove("succeeded");const d=e.trickScoreLog.filter((e=>"combo"===e.type)),u=d.length?Math.max(...d.map((e=>e.accumulator*e.multiplier))):0;s&&(s.innerText=String(e.distance)+"m"),i&&(i.innerText=`${e.coins}x${me}`),o&&(o.innerText=String(e.trickScore)),r&&(r.innerText=String(e.finishedLevel?pe:0)),n&&(n.innerText=String(u)),a&&(a.innerText=String(k(e)));const m=null===(t=ee.auth)||void 0===t?void 0:t.currentUser;if(!m)return void(localStorage.getItem(le)?(null==h||h.classList.add("hidden"),yield ee.submit(e)):(c.value=`Player_${l()}`,c.setAttribute("value",c.value),localStorage.setItem(le,c.value)));if(!c)throw new Error("username input field not found");const p=document.querySelector(".submit-score-offline-info");if(p&&p.classList.add("hidden"),m.displayName){null==h||h.classList.add("hidden"),ee.rexLeaderboard.setUser({userID:m.uid,userName:m.displayName}),yield ee.submit(e);const t=(yield ee.rexLeaderboard.loadFirstPage()).map((e=>Object.assign(Object.assign({},e),{total:k(e,!1)}))).sort(((e,t)=>Number(t.total)-Number(e.total))),s=t.findIndex((e=>e.userID===m.uid)),i=document.getElementById("your-score-rank-value");i&&-1!==s&&(null==t?void 0:t.length)&&(i.innerText=`${s+1}/${t.length}`)}else c.value=`Player_${l()}`,c.setAttribute("value",c.value),localStorage.setItem(le,c.value)}}))}updateLeaderboardPanelData(){var e,t,s,i,o;return V(this,void 0,void 0,(function*(){if(null===(e=ee.auth)||void 0===e?void 0:e.currentUser){const e=document.querySelector(".leaderboard-note");e&&e.classList.add("hidden")}let r=ee.auth?yield ee.rexLeaderboard.loadFirstPage():(JSON.parse(localStorage.getItem(ce)||"{}")[R()]||[]).map((e=>Object.assign(Object.assign({},e),{userName:localStorage.getItem(le)})));const n=document.getElementById("leaderboard-item-template"),a=document.getElementById("leaderboard-item-container");if(this.panelLeaderboards&&n&&a){const e=(null===(s=null===(t=ee.auth)||void 0===t?void 0:t.currentUser)||void 0===s?void 0:s.displayName)||localStorage.getItem(le),l=r.map((e=>Object.assign(Object.assign({},e),{total:k(e,!1)}))).sort(((e,t)=>Number(t.total)-Number(e.total)));a.innerText="";for(const[t,s]of l.entries()){const r=s.userName,l=n.content.cloneNode(!0),c=l.querySelector("#leaderboard-item-rank"),h=l.querySelector("#leaderboard-item-username"),d=l.querySelector("#leaderboard-item-score");c&&(c.innerHTML=String(t+1)),h&&(h.innerHTML=String(r)),d&&(d.innerHTML=String(k(s))),!h||!e||(null===(o=null===(i=ee.auth)||void 0===i?void 0:i.currentUser)||void 0===o?void 0:o.uid)!==s.userID&&ee.auth||h.classList.add("your-own-score"),a.appendChild(l)}}}))}updateLevelItems(){return V(this,void 0,void 0,(function*(){const e=document.getElementById("level-item-template"),t=document.getElementById("level-item-container");if(this.panelSelectLevel&&e&&t){t.innerText="";for(const s of T){const i=e.content.cloneNode(!0),o=i.querySelector(".level-item-overlay"),r=i.querySelector(".level-item-number"),n=i.querySelector(".level-item-name"),a=i.querySelector(".level-item-thumbnail");o&&(o.id=s.id),r&&(r.innerHTML=`Level ${String(s.number).padStart(3,"0")}`),n&&(n.innerHTML=s.name),a&&(a.style.backgroundImage=`url('${s.thumbnail}')`),t.appendChild(i)}}}))}}class z{constructor(e){this.scene=e,this.character=null,this.jumpKeyDownStartFrame=0,this.scene.observer.on(A,(()=>this.pauseGame())),this.scene.observer.on(E,(()=>this.pauseGame(O.PANEL_HOW_TO_PLAY))),this.scene.observer.on(I,(()=>this.scene.b2Physics.isPaused=!1)),this.scene.observer.on(P,((e,t)=>{var s;t===(null===(s=this.character)||void 0===s?void 0:s.id)&&this.scene.cameras.main.shake(200,1/this.resolutionMod*.03)})),this.initKeyboardInputs()}possessCharacter(e){var t;this.character=e,G.possessedCharacterId=e.id;const s=this.scene.cameras.main;this.resolutionMod=s.width/fe,s.setDeadzone(0,125),s.setZoom(Pe*this.resolutionMod*1.5),s.scrollX-=s.width,s.scrollY-=s.height;const i=null===(t=this.scene.b2Physics.loader.userData.get(this.character.body))||void 0===t?void 0:t.image;i&&s.startFollow(i,!1,.5,.5)}update(){this.scene.b2Physics.isPaused||this.character&&(this.jumpKeyDown&&this.scene.game.getFrame()-this.jumpKeyDownStartFrame<=this.character.jumpCooldown&&this.character.jump(),this.jumpKeyDown&&this.character.leanUp(),(this.keyArrowLeft.isDown||this.keyA.isDown)&&this.character.leanBackward(),(this.keyArrowRight.isDown||this.keyD.isDown)&&this.character.leanForward(),(this.keyArrowDown.isDown||this.keyS.isDown)&&this.character.leanCenter(),this.setZoomLevel(this.character),this.setWindNoise(this.character),this.setFollowOffset(this.character))}setZoomLevel(e){const t=this.scene.cameras.main.zoom,s=e.state.getCurrentSpeed(),i=Pe,o=t+.02*((i-Math.min(Math.max(s/40,0),1)*(i-.5))*this.resolutionMod-t);this.scene.cameras.main.setZoom(o)}setWindNoise(e){const t=e.head.GetLinearVelocity().Length();this.scene.observer.emit(C,t/60)}setFollowOffset(e){const t=10*e.body.GetLinearVelocity().x,{followOffset:s}=this.scene.cameras.main;this.scene.cameras.main.setFollowOffset(s.x+.01*(-t-s.x),0)}initKeyboardInputs(){const e=this.scene.input.keyboard;if(!e)throw new Error("Keyboard input not available. No touch input supported yet.");this.keySpace=e.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),this.keyW=e.addKey(Phaser.Input.Keyboard.KeyCodes.W),this.keyA=e.addKey(Phaser.Input.Keyboard.KeyCodes.A),this.keyS=e.addKey(Phaser.Input.Keyboard.KeyCodes.S),this.keyD=e.addKey(Phaser.Input.Keyboard.KeyCodes.D),this.keyArrowUp=e.addKey(Phaser.Input.Keyboard.KeyCodes.UP),this.keyArrowLeft=e.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),this.keyArrowRight=e.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),this.keyArrowDown=e.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),this.keySpace.onDown=()=>this.pauseGame();const t=()=>{var e;this.jumpKeyDown=!0,(null===(e=this.character)||void 0===e?void 0:e.board.isInAir())||this.scene.b2Physics.isPaused||(this.jumpKeyDownStartFrame=this.scene.game.getFrame())};this.keyW.onDown=t,this.keyArrowUp.onDown=t,this.keyW.onUp=()=>this.jumpKeyDown=!1,this.keyArrowUp.onUp=()=>this.jumpKeyDown=!1}pauseGame(e=O.PANEL_PAUSE_MENU){this.character&&(this.character.state.isCrashed||this.character.state.isLevelFinished||(this.scene.b2Physics.isPaused=!this.scene.b2Physics.isPaused,this.character.state.updateComboLeeway(),this.scene.observer.emit(B,this.scene.b2Physics.isPaused,e)))}}class J{constructor(e){this.character=e,this.segments=[],this.scene=e.scene,this.ZERO=new Ie.b2Vec2(0,0),this.initRays(this.scene.b2Physics.worldScale/4),this.particles=this.initParticles();const{worldScale:t,loader:{customProps:s}}=this.scene.b2Physics;this.scene.b2Physics.on(_,(({contact:e,impulse:i,bodyA:o,bodyB:r})=>{const n=s.get(o),a=s.get(r);if(n&&"snow"!==n.surfaceType&&a&&"snow"!==a.surfaceType)return;const l=(n&&"snow"!==n.surfaceType?o:r).GetLinearVelocity().Length(),h=new Ie.b2WorldManifold;e.GetWorldManifold(h);for(let e=0;e<i.get_count();e++){const s=c.Scale(h.get_points(e),t,-t),n=i.get_normalImpulses(e);if(this.scene.cameras.main.worldView.contains(s.x,s.y)&&!(n<4||l<.5)&&(this.particles.emitParticleAt(s.x,s.y,Math.min(1.5*n,25)),this.character.isPartOfMe(o)||this.character.isPartOfMe(r))){const e=this.segments[3].groundRayResult.hit;this.scene.observer.emit(x,n,"snow",!1,e,!1)}}Ie.destroy(h)}))}getFramesInAir(){if(this.segments.some((e=>e.groundRayResult.hit)))return-1;let e=0;for(const t of this.segments)e=Math.max(e,t.groundRayResult.lastHitFrame);return this.scene.game.getFrame()-e}isInAir(){return-1!==this.getFramesInAir()}update(){const e=this.segments;for(const e of this.segments){e.groundRayResult.hit=!1,e.groundRayResult.point.SetZero(),e.groundRayResult.normal.SetZero(),e.groundRayResult.fraction=-1;const t=c.Clone(e.body.GetWorldPoint(this.ZERO)),s=c.Clone(e.body.GetWorldPoint(e.groundRayDirection));this.scene.b2Physics.world.RayCast(e.groundRayCallback,t,s)}this.isTailGrounded=e[0].groundRayResult.hit,this.isNoseGrounded=e[e.length-1].groundRayResult.hit,this.isCenterGrounded=e[3].groundRayResult.hit}initRays(e){const{loader:t}=this.scene.b2Physics,s=t.getBodiesByCustomProperty("phaserPlayerCharacterPart","boardSegment",this.character.id);if(7!==s.length)throw new Error("Player character board segments missing");s.sort(((e,s)=>Number(t.customProps.get(e).phaserBoardSegmentIndex)-Number(t.customProps.get(s).phaserBoardSegmentIndex)));const i=new Ie.b2Vec2(0,-e/this.scene.b2Physics.worldScale);for(const e of s){const t={hit:!1,point:new Ie.b2Vec2(0,0),normal:new Ie.b2Vec2(0,0),fraction:-1,lastHitFrame:-1},s=new Ie.JSRayCastCallback;s.ReportFixture=(e,s,i,o)=>{if(Ie.wrapPointer(e,Ie.b2Fixture).IsSensor())return-1;const{x:r,y:n}=Ie.wrapPointer(s,Ie.b2Vec2),{x:a,y:l}=Ie.wrapPointer(i,Ie.b2Vec2);return t.hit=!0,t.point.Set(r,n),t.normal.Set(a,l),t.fraction=o,t.lastHitFrame=this.scene.game.getFrame(),o},this.segments.push({body:e,groundRayDirection:i,groundRayResult:t,groundRayCallback:s})}}initParticles(){const e=this.scene.add.graphics().setDepth(1e7);return e.fillStyle(Se?65793:16777215,1),e.fillCircle(8,8,8),e.generateTexture("circle_01",16,16),e.destroy(),this.scene.add.particles(0,0,"circle_01",{active:!0,visible:!0,emitting:!1,particleBringToTop:!0,radial:!0,blendMode:0,gravityY:100,delay:100,frequency:0,maxParticles:0,timeScale:1,alpha:1,angle:{min:0,max:360},lifespan:{min:600,max:1250},quantity:{min:2,max:10},scale:{ease:"Linear",min:.1,max:.25},speed:{min:25,max:100}}).setDepth(-10)}}class U{constructor(e){this.character=e,this.isLevelFinished=!1,this.isCrashed=!1,this.timeGrounded=0,this.pickupsToProcess=new Set,this.seenSensors=new Set,this.comboLeeway=null,this.comboAccumulatedScore=0,this.comboMultiplier=0,this.totalTrickScore=0,this.totalCollectedPresents=0,this.trickScoreLog=[],this.anglePreviousUpdate=0,this.totalRotation=0,this.currentFlipRotation=0,this.pendingFrontFlips=0,this.pendingBackFlips=0,this.landedFrontFlips=0,this.landedBackFlips=0,this.lastDistance=0,this.lastIsInAir=!1,this.scene=e.scene,this.registerListeners()}getCurrentScore(){return{distance:this.getTravelDistanceMeters(),coins:this.totalCollectedPresents,trickScore:this.totalTrickScore,finishedLevel:this.isLevelFinished,crashed:this.isCrashed,trickScoreLog:this.trickScoreLog,level:R()}}getCurrentSpeed(){return this.character.body.GetLinearVelocity().Length()}createComboLeewayTween(e=!0){return this.scene.tweens.addCounter({paused:e,from:-.5*Math.PI,to:1.5*Math.PI,duration:4e3,onUpdate:e=>this.scene.observer.emit(f,e.getValue()),onComplete:e=>this.handleComboComplete()})}reset(){this.totalTrickScore=0,this.trickScoreLog=[],this.comboLeeway&&(this.comboLeeway.stop(),this.comboLeeway=null),this.totalCollectedPresents=0,this.comboMultiplier=0,this.comboAccumulatedScore=0,this.isLevelFinished=!1,this.isCrashed=!1,this.seenSensors.clear(),this.pickupsToProcess.clear(),this.pendingFrontFlips=0,this.pendingBackFlips=0,this.landedBackFlips=0,this.landedFrontFlips=0,this.currentFlipRotation=0,this.anglePreviousUpdate=0,this.lastDistance=0,this.timeGrounded=0,this.totalRotation=0}getTravelDistanceMeters(){const e=this.character.body.GetPosition().x;return 5*Math.floor(e/5)}registerListeners(){const e=this.scene.b2Physics.loader.customProps;this.scene.b2Physics.on(L,(({bodyA:t,bodyB:s,fixtureA:i,fixtureB:o})=>{var r,n;(this.character.isPartOfMe(t)||this.character.isPartOfMe(s))&&(i.IsSensor()&&!this.seenSensors.has(t)&&(null===(r=e.get(i))||void 0===r?void 0:r.phaserSensorType)?this.handleSensor(t,i):o.IsSensor()&&!this.seenSensors.has(s)&&(null===(n=e.get(o))||void 0===n?void 0:n.phaserSensorType)&&this.handleSensor(s,o))})),this.scene.b2Physics.on(_,(({fixtureA:e,fixtureB:t,impulse:s})=>{if(this.isCrashed)return;const i=e.GetBody(),o=t.GetBody();if(i===o)return;let r=-1;for(let e=0;e<s.count;e++)r=Math.max(r,s.get_normalImpulses(e));(i===this.character.head||o===this.character.head)&&r>be&&this.setCrashed()})),this.scene.observer.on(v,(()=>{this.timeGrounded=this.scene.game.getFrame(),this.landedFrontFlips+=this.pendingFrontFlips,this.landedBackFlips+=this.pendingBackFlips;const e=this.pendingBackFlips+this.pendingFrontFlips;if(e>=1){this.trickScoreLog.push({type:"flip",flips:e,timestamp:Date.now()});const t=e*e*ge;this.totalTrickScore+=t,this.comboAccumulatedScore+=t*ye,this.comboMultiplier++,this.scene.observer.emit(y,this.comboAccumulatedScore,this.comboMultiplier),this.scene.observer.emit(g,this.getCurrentScore()),this.resetComboLeewayTween(),this.comboLeeway=this.createComboLeewayTween(!1)}this.totalRotation=0,this.currentFlipRotation=0,this.pendingBackFlips=0,this.pendingFrontFlips=0}))}setCrashed(){this.isCrashed=!0,this.scene.observer.emit(P,this.getCurrentScore(),this.character.id),this.resetComboLeewayTween()}handleSensor(e,t){var s;if(this.seenSensors.add(e),!this.isCrashed&&!this.isLevelFinished)switch(null===(s=this.scene.b2Physics.loader.customProps.get(t))||void 0===s?void 0:s.phaserSensorType){case"pickup_present":this.pickupsToProcess.add(e);break;case"level_finish":{this.scene.cameras.main.stopFollow(),this.handleComboComplete(),this.isLevelFinished=!0,this.resetComboLeewayTween();const e=this.getCurrentScore();this.scene.observer.emit(g,e),this.scene.observer.emit(w,e);break}case"level_deathzone":this.setCrashed()}}update(){this.processPickups();const e=this.character.board.isInAir();!e||this.lastIsInAir||this.isCrashed?e||!this.lastIsInAir||this.isCrashed||this.scene.observer.emit(v):this.scene.observer.emit(S),this.updateTrickCounter(),this.updateComboLeeway(),this.updateDistance(),this.lastIsInAir=e}processPickups(){for(const e of this.pickupsToProcess){const t=this.scene.b2Physics.loader.userData.get(e),s=null==t?void 0:t.image;s&&(t.image=null,s.destroy()),this.scene.b2Physics.loader.userData.delete(e),this.scene.b2Physics.world.DestroyBody(e),this.totalCollectedPresents++,this.scene.observer.emit(b,this.totalCollectedPresents),this.scene.observer.emit(g,this.getCurrentScore())}this.pickupsToProcess.clear()}updateTrickCounter(){if(this.character.board.isInAir()){const e=Phaser.Math.Angle.Normalize(this.character.body.GetAngle()),t=this.calculateDifferenceBetweenAngles(this.anglePreviousUpdate,e);this.totalRotation+=t,this.currentFlipRotation+=t,this.anglePreviousUpdate=e,this.currentFlipRotation>=Math.PI*(0===this.pendingBackFlips?1.25:2)?(this.pendingBackFlips++,this.currentFlipRotation=0):this.currentFlipRotation<=Math.PI*-(0===this.pendingFrontFlips?1.25:2)&&(this.pendingFrontFlips++,this.currentFlipRotation=0)}}updateComboLeeway(){this.comboLeeway&&(this.character.board.isInAir()||!this.character.board.isCenterGrounded||this.scene.b2Physics.isPaused?this.comboLeeway.isPlaying()&&this.comboLeeway.pause():this.comboLeeway.isPaused()&&this.comboLeeway.resume())}resetComboLeewayTween(){this.comboLeeway&&(this.comboLeeway.stop(),this.comboLeeway=null)}calculateDifferenceBetweenAngles(e,t){let s=t-e;return s<-Math.PI?s+=2*Math.PI:s>Math.PI&&(s-=2*Math.PI),s}updateDistance(){const e=this.getTravelDistanceMeters();e===this.lastDistance||this.isCrashed||this.isLevelFinished||(this.scene.observer.emit("distance_change",e),this.scene.observer.emit(g,this.getCurrentScore()),this.lastDistance=e)}handleComboComplete(){if(this.isLevelFinished)return;const e=this.comboAccumulatedScore*this.comboMultiplier;this.totalTrickScore+=e,this.trickScoreLog.push({type:"combo",multiplier:this.comboMultiplier,accumulator:this.comboAccumulatedScore,timestamp:Date.now()}),this.scene.observer.emit(g,this.getCurrentScore()),this.scene.observer.emit(y,0,0),this.comboAccumulatedScore=0,this.comboMultiplier=0}}class q{constructor(e,t=""){this.scene=e,this.rubeSceneId=t,this.FORWARD=new Ie.b2Vec2(1,0),this.ZERO=new Ie.b2Vec2(0,0),this.UP=new Ie.b2Vec2(0,1),this.alreadyDetached=!1,this.currentBodyFlipDot=1,this.initBodyParts(),this.id=t,this.state=new U(this),this.board=new J(this),q.instances.push(this)}resetLegs(){var e,t;const{legLengthRelaxed:s}=this;null===(e=this.distanceLegLeft)||void 0===e||e.SetLength(s),null===(t=this.distanceLegRight)||void 0===t||t.SetLength(s)}leanBackward(){var e,t;const{legLengthBent:s,legLengthExtended:i,leanForce:o}=this;null===(e=this.distanceLegLeft)||void 0===e||e.SetLength(s),null===(t=this.distanceLegRight)||void 0===t||t.SetLength(i),this.body.ApplyAngularImpulse(o,!0)}leanForward(){var e,t;const{legLengthBent:s,legLengthExtended:i,leanForce:o}=this;null===(e=this.distanceLegLeft)||void 0===e||e.SetLength(i),null===(t=this.distanceLegRight)||void 0===t||t.SetLength(s),this.body.ApplyAngularImpulse(-o,!0)}leanCenter(){var e,t;const{legLengthBent:s}=this;null===(e=this.distanceLegLeft)||void 0===e||e.SetLength(s),null===(t=this.distanceLegRight)||void 0===t||t.SetLength(s)}leanUp(){var e,t;const{legLengthExtended:s}=this;null===(e=this.distanceLegLeft)||void 0===e||e.SetLength(s),null===(t=this.distanceLegRight)||void 0===t||t.SetLength(s)}jump(){if(this.scene.game.getFrame()-this.state.timeGrounded<6)return;const{isTailGrounded:e,isCenterGrounded:t,isNoseGrounded:s}=this.board;if(t||e||s){const e=t?c.Add(this.body.GetWorldVector(new Ie.b2Vec2(0,.35*this.jumpForce)),{x:0,y:1.2*this.jumpForce}):c.Add(this.body.GetWorldVector(new Ie.b2Vec2(0,.55*this.jumpForce)),{x:0,y:.8*this.jumpForce});this.body.ApplyLinearImpulseToCenter(e,!0)}}isPartOfMe(e){var t;return null===(t=this.scene.b2Physics.loader.loadedScenes.get(this.id))||void 0===t?void 0:t.bodies.some((t=>t===e))}update(){this.state.update(),this.board.getFramesInAir()>6&&this.resetLegs(),this.state.isCrashed&&!this.alreadyDetached&&this.detachBoard(),this.state.isCrashed||this.state.isLevelFinished||(this.board.update(),this.updateLookAtDirection(),this.state.isCrashed&&!this.alreadyDetached&&this.detachBoard())}updateLookAtDirection(){this.scene.b2Physics.loader.userData;const e=c.Normalize(c.Clone(this.body.GetLinearVelocity())),t=c.Normalize(this.body.GetWorldVector(this.FORWARD)),s=this.board.isInAir()?.005:.03,i=c.Dot(t,e)<0?-1:1;this.currentBodyFlipDot=this.currentBodyFlipDot+s*(i-this.currentBodyFlipDot),this.currentBodyFlipDot<0?(this.headImage.flipX=!0,this.bodyImage.flipX=!0,this.armUpperLeftImage.setDepth(this.armUpperRightDepth),this.armUpperRightImage.setDepth(this.armUpperLeftDepth),this.armLowerLeftImage.setDepth(this.armLowerRightDepth),this.armLowerRightImage.setDepth(this.armLowerLeftDepth)):(this.headImage.flipX=!1,this.bodyImage.flipX=!1,this.armUpperLeftImage.setDepth(this.armUpperLeftDepth),this.armUpperRightImage.setDepth(this.armUpperRightDepth),this.armLowerLeftImage.setDepth(this.armLowerLeftDepth),this.armLowerRightImage.setDepth(this.armLowerRightDepth))}detachBoard(){const e=this.scene.b2Physics.world;this.bindingLeft&&e.DestroyJoint(Ie.getPointer(this.bindingLeft)),this.bindingRight&&e.DestroyJoint(Ie.getPointer(this.bindingRight)),this.distanceLegLeft&&e.DestroyJoint(Ie.getPointer(this.distanceLegLeft)),this.distanceLegRight&&e.DestroyJoint(Ie.getPointer(this.distanceLegRight)),this.weldCenter&&e.DestroyJoint(Ie.getPointer(this.weldCenter)),this.prismatic&&e.DestroyJoint(Ie.getPointer(this.prismatic)),this.alreadyDetached=!0}initBodyParts(e=""){const t="phaserPlayerCharacterPart",s="phaserPlayerCharacterSpring",i=this.scene.b2Physics.loader,o=i.getBodiesByCustomProperty(t,"head",e)[0],r=i.getBodiesByCustomProperty(t,"body",e)[0],n=i.getBodiesByCustomProperty(t,"armUpperLeft",e)[0],a=i.getBodiesByCustomProperty(t,"armLowerLeft",e)[0],l=i.getBodiesByCustomProperty(t,"armUpperRight",e)[0],c=i.getBodiesByCustomProperty(t,"armLowerRight",e)[0],h=i.userData.get(o).image,d=i.userData.get(r).image,u=i.userData.get(n).image,m=i.userData.get(a).image,p=i.userData.get(l).image,g=i.userData.get(c).image,y=i.customProps.get(r).legLengthExtended,b=i.customProps.get(r).legLengthRelaxed,f=i.customProps.get(r).legLengthBent,w=i.customProps.get(r).jumpForce,v=i.customProps.get(r).leanForce,P=i.customProps.get(r).jumpCooldown,S=i.getJointsByCustomProperty(s,"bindingLeft",e)[0],L=i.getJointsByCustomProperty(s,"bindingRight",e)[0],_=i.getJointsByCustomProperty(s,"distanceLegLeft",e)[0],x=i.getJointsByCustomProperty(s,"distanceLegRight",e)[0],C=i.getJointsByCustomProperty(s,"weldCenter",e)[0],B=i.getJointsByCustomProperty(s,"prismatic",e)[0];if(!(h&&d&&u&&m&&p&&g))throw new Error("Player character images not found");if(!(S&&L&&_&&x&&C&&B))throw new Error("Player character joints not found");if(!(o&&r&&n&&a&&l&&c))throw new Error("Player character b2Bodies not found");if(!y||!b||!f)throw new Error("Player character leg lengths not found. Need to be set on character torso body");if(!w||!v||!P)throw new Error("Player character jump/lean properties not found. Need to be set on character torso body");this.head=o,this.body=r,this.armUpperLeft=n,this.armLowerLeft=a,this.armUpperRight=l,this.armLowerRight=c,this.headImage=h,this.bodyImage=d,this.armUpperLeftImage=u,this.armLowerLeftImage=m,this.armUpperRightImage=p,this.armLowerRightImage=g,this.armUpperLeftDepth=u.depth,this.armLowerLeftDepth=m.depth,this.armUpperRightDepth=p.depth,this.armLowerRightDepth=g.depth,this.bindingLeft=Ie.castObject(S,Ie.b2RevoluteJoint),this.bindingRight=Ie.castObject(L,Ie.b2RevoluteJoint),this.distanceLegLeft=Ie.castObject(_,Ie.b2DistanceJoint),this.distanceLegRight=Ie.castObject(x,Ie.b2DistanceJoint),this.weldCenter=Ie.castObject(C,Ie.b2WeldJoint),this.prismatic=Ie.castObject(B,Ie.b2PrismaticJoint),this.legLengthExtended=y,this.legLengthRelaxed=b,this.legLengthBent=f,this.jumpForce=w,this.leanForce=v,this.jumpCooldown=P}}q.instances=[];var W=function(e,t,s,i){return new(s||(s=Promise))((function(o,r){function n(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,a)}l((i=i.apply(e,t||[])).next())}))};class K{constructor(e){this.scene=e;const t=Number(localStorage.getItem(re)||80)/100,s=Object.values(Ce)[Math.floor(Math.random()*Object.values(Ce).length)];this.music=this.scene.sound.add(s,{loop:!0,volume:.5*t,rate:1,delay:1,detune:0}),this.music.play();const i=Number(localStorage.getItem(ne)||80)/100;this.sfx_pickup_present=this.scene.sound.add("pickup_present",{detune:0,rate:1,volume:.6*i}),this.sfx_death=this.scene.sound.add("death",{detune:700,rate:1.25,volume:.8*i}),this.sfx_grunt=this.scene.sound.add("grunt",{detune:400,rate:1.25,volume:.5*i}),this.sfx_applause=this.scene.sound.add("applause",{detune:0,rate:1,volume:.6*i}),this.sfx_game_over_demon=this.scene.sound.add("game_over_demon",{detune:0,rate:.95,volume:.6*i}),this.sfx_snowboardSlide=this.scene.sound.add("snowboard_slide_04",{loop:!0,volume:.03,rate:1,delay:0,detune:1e3}),this.sfx_windNoise=this.scene.sound.add("wind",{loop:!0,volume:.02,rate:1,delay:0,detune:0}),this.sfx_snowboardSlide.play(),this.sfx_windNoise.play(),this.initListeners()}initListeners(){this.scene.observer.on(b,(e=>this.sfx_pickup_present.play())),this.scene.observer.on(P,((e,t)=>{t===G.possessedCharacterId&&(this.sfx_death.play(),this.sfx_grunt.play(),this.sfx_game_over_demon.play(),this.scene.tweens.add({targets:this.music,volume:0,detune:-500,rate:.5,duration:750,onComplete:()=>W(this,void 0,void 0,(function*(){return this.music.stop()}))}))})),this.scene.observer.on(w,(()=>{this.sfx_applause.play(),this.scene.tweens.add({targets:this.music,duration:2e3,volume:0,onComplete:()=>W(this,void 0,void 0,(function*(){return this.music.stop()}))})})),this.scene.observer.on(x,((e,t,s,i,o)=>{const r=i?0:1200,n=this.sfx_snowboardSlide.detune,a=n+.7*(r-n);this.sfx_snowboardSlide.setDetune(a);const l=Math.min(e/12,1),c=Math.max(Math.min(l,1),.2);this.sfx_snowboardSlide.setVolume(c)})),this.scene.observer.on(S,(()=>{this.scene.add.tween({targets:this.sfx_snowboardSlide,volume:.03,ease:"Linear",duration:250,onComplete:()=>this.sfx_snowboardSlide.setDetune(0)})})),this.scene.observer.on(C,(e=>{this.sfx_windNoise.setVolume(Math.min(Math.max(.3*e,.02),.5)),this.sfx_windNoise.setRate(Math.min(Math.max(1.5*e,.5),1.5))})),this.scene.observer.on(D,(()=>{this.music.destroy(),this.sfx_game_over_demon.destroy(),this.sfx_applause.destroy(),this.sfx_snowboardSlide.stop(),this.sfx_snowboardSlide.destroy(),this.sfx_windNoise.destroy(),this.sfx_pickup_present.destroy(),this.sfx_death.destroy(),this.sfx_grunt.destroy()}))}}class H{constructor(e){this.scene=e,this.resolutionMod=this.scene.cameras.main.width/fe;const t=this.scene.add.graphics();t.fillStyle(Se?6710886:3436742,1),t.fillRect(0,0,fe*this.resolutionMod,we*this.resolutionMod),t.generateTexture("bg_sky",fe*this.resolutionMod,we*this.resolutionMod),t.destroy(),this.bgSky=this.registerLayer("bg_sky",""),Se&&(this.bgSpaceMid=this.registerLayer("bg_space_pack","bg_space_mid.png"),this.bgSpaceFront=this.registerLayer("bg_space_pack","bg_space_front.png"))}update(){const{scrollX:e,scrollY:t,zoomX:s,zoomY:i}=this.scene.cameras.main;Se&&(this.bgSpaceMid.setTilePosition(.01*e*.2,.01*t*.2).setScale(1/s*1,1/i*1),this.bgSpaceFront.setTilePosition(.025*e*.2,.025*t*.2).setScale(1/s*1,1/i*1)),this.bgSky.setScale(1/s*1,1/i*1)}registerLayer(e,t,s=1,i=1){const{width:o,height:r,zoomX:n,zoomY:a,worldView:l}=this.scene.cameras.main;return this.scene.add.tileSprite(l.x+o/2,l.y+r/2,o,r,e,t).setOrigin(.5,.5).setScrollFactor(0,0).setScale(s*(1/n),i*(1/a)).setDepth(-200)}}class Y extends Phaser.Scene{constructor(){super({key:se})}create(){this.observer&&this.observer.destroy(),this.observer=new Phaser.Events.EventEmitter,this.b2Physics=new M(this,{worldScale:40,gravityX:0,gravityY:-10}),new K(this),this.backdrop=new H(this),this.b2Physics.load(R()),new a(this).draw(),this.playerController=new z(this);const e=new q(this,this.b2Physics.load((()=>{const e=localStorage.getItem(de);return e&&Ae[e]?e:"character_v02"})(),0,0));this.playerController.possessCharacter(e),this.observer.on(D,(()=>{this.b2Physics.loader.cleanup(),De(),this.scene.restart()})),this.scene.launch(ie,[this.observer]),this.input.keyboard.on("keydown-ONE",(()=>this.b2Physics.serializer.serialize()))}update(){this.b2Physics.update(),q.instances.forEach((e=>e.update())),this.playerController.update(),this.backdrop.update()}}var $=s(10),Z=(s(21),s(237),s(773));const X="303158013990";var Q=function(e,t,s,i){return new(s||(s=Promise))((function(o,r){function n(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,a)}l((i=i.apply(e,t||[])).next())}))};const ee=new class{constructor(){this.numAuthAttempts=0;{window.firebase=$.Z;const e={apiKey:"AIzaSyCCxWe4_fyEhV9Qyv3Sb1GF_AZchgbhBG8",authDomain:"snowboarding-game.firebaseapp.com",projectId:"snowboarding-game",storageBucket:"snowboarding-game.appspot.com",messagingSenderId:X,appId:"1:303158013990:web:d85e188299ea519e1936e7",measurementId:X};$.Z.initializeApp(e),this.auth=$.Z.auth(),this.auth.onAuthStateChanged((e=>Q(this,void 0,void 0,(function*(){if(Le&&console.log("onAuthStateChanged user",e),e)e.displayName&&e.displayName!==localStorage.getItem(le)&&localStorage.setItem(le,e.displayName),this.setLevel(R());else{if(Le&&console.log("try signInAnonymously"),++this.numAuthAttempts>=3)throw new Error("failed to authenticate multiple times.");this.auth.signInAnonymously().catch((e=>console.error("Failed to login anonymous user",e)))}}))))}}setLevel(e){var t;this.numAuthAttempts=0,this.currentLevel=e,localStorage.setItem(he,e),(null===(t=this.auth)||void 0===t?void 0:t.currentUser)&&(this.rexLeaderboard=new Z.wB({root:`leaderboard_${e}`,pageItemCount:200}))}submit(e){var t;return Q(this,void 0,void 0,(function*(){if(e.id=l(),e.timestamp=Date.now(),this.saveScoreLocally(e),null===(t=this.auth)||void 0===t?void 0:t.currentUser){const t=yield this.rexLeaderboard.getScore(this.auth.currentUser.uid);if(!t||k(t)<k(e))return yield this.rexLeaderboard.post(k(e),e,e.timestamp),!0}return!1}))}saveScoreLocally(e){const t=JSON.parse(localStorage.getItem(ce)||"{}"),s=t[e.level]||[];s.push(e),t[e.level]=s,localStorage.setItem(ce,JSON.stringify(t))}},te="PreloadScene",se="GameScene",ie="GameUIScene",oe="snowboarding_game_resolution",re="snowboarding_game_volume_music",ne="snowboarding_game_volume_sfx",ae="snowboarding_game_darkmode_enabled",le="snowboarding_game_user_name",ce="snowboarding_game_user_scores_v3",he="snowboarding_game_level_current",de="snowboarding_game_selected_character",ue="snowboarding_game_selected_character_skin",me=100,pe=5e3,ge=200,ye=.2,be=8,fe=1280,we=720,ve=Number(localStorage.getItem(oe)||1),Pe=Number(localStorage.getItem("snowboarding_game_debug_zoom")||1),Se="true"===localStorage.getItem(ae),Le=Boolean(localStorage.getItem("snowboarding_game_debug"));var _e;!function(e){e.level_001="level_001",e.level_002="level_002",e.level_003="level_003",e.level_004="level_004",e.level_005="level_005"}(_e||(_e={}));const xe=[_e.level_001,_e.level_002,_e.level_003,_e.level_004,_e.level_005],Ce={ContinueLife:"KevinMacLeod/Continue Life",Heartbreaking:"KevinMacLeod/Heartbreaking",RainsWillFall:"KevinMacLeod/Rains Will Fall",SadTrio:"KevinMacLeod/Sad Trio",StagesOfGrief:"KevinMacLeod/Stages of Grief"},Be=["character_v01","character_v02"],Ae=["character_v01_neutral","character_v01_santa","character_v02_neutral","character_v02_santa"],Ee={title:"Snowboarding Game",version:"1.1.1",type:Phaser.WEBGL,backgroundColor:Se?"0x666666":"0x3470c6",disableContextMenu:!0,parent:"phaser-wrapper",fps:{target:60,min:55,smoothStep:!1},scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH,width:fe*ve,height:we*ve},scene:[n,Y,j],plugins:{global:[{key:"rexFirebase",plugin:r.Z,start:!0}]}};let Ie,De,Me;window.onload=()=>{(0,o.h4)().then((e=>{(0,i.Z)({locateFile:()=>e?"Box2D.simd.wasm":"Box2D.wasm"}).then((e=>{Ie=e;const t=new Ie.LeakMitigator;De=t.freeLeaked,Me=t.recordLeak,new Phaser.Game(Ee),navigator.onLine&&function(){const e=document.createElement("script");e.onload=function(){const e=new Stats;document.body.appendChild(e.dom),requestAnimationFrame((function t(){e.update(),requestAnimationFrame(t)}))}, e.src="https://mrdoob.github.io/stats.js/build/stats.min.js",document.head.appendChild(e)}()}))}))},window.onresize}},o={};function r(e){var t=o[e];if(void 0!==t)return t.exports;var s=o[e]={exports:{}};return i[e].call(s.exports,s,s.exports,r),s.exports}r.m=i,e=[],r.O=(t,s,i,o)=>{if(!s){var n=1/0;for(h=0;h<e.length;h++){for(var[s,i,o]=e[h],a=!0,l=0;l<s.length;l++)(!1&o||n>=o)&&Object.keys(r.O).every((e=>r.O[e](s[l])))?s.splice(l--,1):(a=!1,o<n&&(n=o));if(a){e.splice(h--,1);var c=i();void 0!==c&&(t=c)}}return t}o=o||0;for(var h=e.length;h>0&&e[h-1][2]>o;h--)e[h]=e[h-1];e[h]=[s,i,o]},r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,s)=>(r.f[s](e,t),t)),[])),r.u=e=>e+"."+{325:"5c226c1b4e9d0b9aad7f",486:"17e73c9cf56d85afe071"}[e]+".chunk.js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},s="snowboarding-game:",r.l=(e,i,o,n)=>{if(t[e])t[e].push(i);else{var a,l;if(void 0!==o)for(var c=document.getElementsByTagName("script"),h=0;h<c.length;h++){var d=c[h];if(d.getAttribute("src")==e||d.getAttribute("data-webpack")==s+o){a=d;break}}a||(l=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,r.nc&&a.setAttribute("nonce",r.nc),a.setAttribute("data-webpack",s+o),a.src=e),t[e]=[i];var u=(s,i)=>{a.onerror=a.onload=null,clearTimeout(m);var o=t[e];if(delete t[e],a.parentNode&&a.parentNode.removeChild(a),o&&o.forEach((e=>e(i))),s)return s(i)},m=setTimeout(u.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=u.bind(null,a.onerror),a.onload=u.bind(null,a.onload),l&&document.head.appendChild(a)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var i=s.length-1;i>-1&&!e;)e=s[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{r.b=document.baseURI||self.location.href;var e={179:0};r.f.j=(t,s)=>{var i=r.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var o=new Promise(((s,o)=>i=e[t]=[s,o]));s.push(i[2]=o);var n=r.p+r.u(t),a=new Error;r.l(n,(s=>{if(r.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var o=s&&("load"===s.type?"missing":s.type),n=s&&s.target&&s.target.src;a.message="Loading chunk "+t+" failed.\n("+o+": "+n+")",a.name="ChunkLoadError",a.type=o,a.request=n,i[1](a)}}),"chunk-"+t,t)}},r.O.j=t=>0===e[t];var t=(t,s)=>{var i,o,[n,a,l]=s,c=0;if(n.some((t=>0!==e[t]))){for(i in a)r.o(a,i)&&(r.m[i]=a[i]);if(l)var h=l(r)}for(t&&t(s);c<n.length;c++)o=n[c],r.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return r.O(h)},s=self.webpackChunksnowboarding_game=self.webpackChunksnowboarding_game||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var n=r.O(void 0,[216],(()=>r(384)));n=r.O(n)})();